<!-- chat/templates/chat/room.html -->
{% extends "base.html" %}
{% load static %}
{% load chat_extras %}

{% block title %}
{% if room_name == 'general' %}Беседка - Чат{% elif room_name == 'vip' %}Беседка - VIP{% else %}Чат: {{ room_name }}{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat_styles.css' %}?v=14.0">
<style>
/* === ПРИНУДИТЕЛЬНЫЕ СТИЛИ ДЛЯ ЦИТАТ === */
.quoted-message,
.reply-quote,
.message .quoted-message,
.message .reply-quote {
    background: rgba(173, 216, 230, 0.15) !important;
    border: 3px solid #87CEEB !important;
    border-radius: 0.75rem !important;
    padding: 0.875rem !important;
    margin-bottom: 1rem !important;
    font-size: 0.875rem !important;
    cursor: pointer !important;
    box-shadow: 0 3px 10px rgba(135, 206, 235, 0.2) !important;
    transition: all 0.2s ease !important;
}

.quoted-message:hover,
.reply-quote:hover,
.message .quoted-message:hover,
.message .reply-quote:hover {
    background: rgba(173, 216, 230, 0.25) !important;
    border-color: #4FC3F7 !important;
    transform: translateY(-1px) !important;
    box-shadow: 0 4px 15px rgba(135, 206, 235, 0.3) !important;
}

.quote-author,
.reply-quote-author {
    font-weight: 700 !important;
    color: #0056b3 !important;
    margin-bottom: 0.25rem !important;
    font-size: 0.8rem !important;
}

.quote-text,
.reply-quote-text {
    color: #333 !important;
    line-height: 1.3 !important;
    font-weight: 400 !important;
    font-style: italic !important;
    opacity: 0.8 !important;
}
</style>
{% endblock %}

{% block main_container %}
<div class="chat-wrapper">
    <div class="chat-container">
        <!-- Хедер чата -->
        <div class="chat-header {% if room_name == 'vip' %}vip-header{% endif %}">
            <div class="chat-title-section">
                <div class="chat-status-button" id="connection-status">
                    <i class="fas fa-lock"></i>
                </div>
                <h4>{% if room_name == 'vip' %}Беседка - VIP{% else %}Беседка{% endif %}</h4>
            </div>

            <div class="chat-switcher">
                {% if room_name == 'general' %}
                    <button class="chat-switch-btn active" disabled>Общий</button>
                    {% if user.role == 'owner' %}
                        <a href="/chat/vip/" class="chat-switch-btn chat-vip-btn">VIP</a>
                    {% endif %}
                {% elif room_name == 'vip' %}
                    <a href="/chat/general/" class="chat-switch-btn chat-general-btn">Общий</a>
                    <button class="chat-switch-btn active" disabled>VIP</button>
                {% endif %}
            </div>
        </div>

        <!-- Основная область чата -->
        <div class="chat-body">
            <!-- Область сообщений -->
            <div class="chat-messages-area">
                <div id="chat-messages" class="chat-messages">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                        <p>Загружаем историю сообщений...</p>
                    </div>
                </div>

                <!-- Индикатор режима ответа -->
                <div id="reply-indicator-area" class="reply-indicator" style="display: none;">
                    <div class="reply-indicator-content">
                        <div class="reply-indicator-text">
                            <i class="fas fa-reply me-2"></i>
                            <span id="reply-to-text">В ответ на:</span>
                        </div>
                        <button id="cancel-reply-btn" class="cancel-reply-btn" title="Отменить ответ">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Индикатор печати -->
                <div id="typing-indicator" class="typing-indicator"></div>
            </div>

            <!-- Боковая панель пользователей -->
            <div class="users-sidebar {% if room_name == 'vip' %}vip-sidebar{% endif %}">
                <div class="users-header">
                    <span class="users-title">Онлайн</span>
                    <span class="badge" id="online-count">0</span>
                </div>
                <div id="users-list" class="users-list">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-user-slash mb-2"></i>
                        <p class="small mb-0">Загрузка...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Нижняя панель -->
        <div class="chat-bottom-area">
            <!-- Панель статистики -->
            <div class="chat-stats-panel">
                <div class="stats-info">
                    <i class="fas fa-comment-dots me-2"></i>
                    <span id="messages-count">0</span> сообщений
                </div>
            </div>

            <!-- Поле ввода сообщения -->
            <div class="chat-input-area">
                <div class="input-group-optimized">
                    <input id="chat-message-input"
                           type="text"
                           class="form-control-optimized"
                           placeholder="Введите сообщение..."
                           maxlength="2000">
                    <button id="chat-message-submit" class="btn-send-optimized">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Контекстное меню для сообщений -->
    <div id="message-context-menu" class="context-menu" style="display: none;">
        <div class="context-menu-item" data-action="reply">
            <i class="fas fa-reply me-2"></i>Ответить
        </div>
        <div class="context-menu-item" data-action="quote">
            <i class="fas fa-quote-right me-2"></i>Цитировать
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="pin">
            <i class="fas fa-thumbtack me-2"></i>Закрепить
        </div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" data-action="copy">
            <i class="fas fa-copy me-2"></i>Копировать
        </div>
    </div>
</div>

<!-- Данные для JavaScript -->
{{ room_name|json_script:"room-name" }}
{{ user.username|json_script:"current-user" }}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/chat_client.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Получаем данные из Django
    const roomName = JSON.parse(document.getElementById('room-name').textContent);
    const currentUser = JSON.parse(document.getElementById('current-user').textContent);

    // Инициализируем современный ChatClient v5.0
    const chatClient = new ChatClient(roomName, currentUser);
    chatClient.init();

    // Контекстное меню для сообщений (Desktop)
    setupContextMenu();

    // Мобильные жесты (Touch)
    setupMobileGestures();

    // Клавиатурные сокращения
    setupKeyboardShortcuts();
});

// Настройка контекстного меню для Desktop
function setupContextMenu() {
    const contextMenu = document.getElementById('message-context-menu');
    const messagesContainer = document.getElementById('chat-messages');
    let currentMessageId = null;
    let currentMessageAuthor = null;

    // Показ контекстного меню по ПКМ
    messagesContainer.addEventListener('contextmenu', function(e) {
        const messageElement = e.target.closest('.message');
        if (!messageElement) return;

        e.preventDefault();

        currentMessageId = messageElement.getAttribute('data-message-id');
        currentMessageAuthor = messageElement.getAttribute('data-author');

        // Позиционируем меню
        contextMenu.style.left = e.pageX + 'px';
        contextMenu.style.top = e.pageY + 'px';
        contextMenu.style.display = 'block';

        // Добавляем временный обработчик для скрытия меню
        document.addEventListener('click', hideContextMenu, { once: true });
    });

    // Обработка действий контекстного меню
    contextMenu.addEventListener('click', function(e) {
        const action = e.target.closest('.context-menu-item')?.getAttribute('data-action');
        if (!action) return;

        switch(action) {
            case 'reply':
                window.chatClientInstance?.setReplyMode(currentMessageId, currentMessageAuthor);
                break;
            case 'quote':
                window.chatClientInstance?.setQuoteMode(currentMessageId, currentMessageAuthor);
                break;
            case 'pin':
                pinMessage(currentMessageId);
                break;
            case 'copy':
                copyMessageText(currentMessageId);
                break;
        }

        hideContextMenu();
    });

    function hideContextMenu() {
        contextMenu.style.display = 'none';
    }
}

// Настройка мобильных жестов
function setupMobileGestures() {
    const messagesContainer = document.getElementById('chat-messages');
    let startX, startY, currentMessageElement;

    messagesContainer.addEventListener('touchstart', function(e) {
        const messageElement = e.target.closest('.message');
        if (!messageElement) return;

        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
        currentMessageElement = messageElement;
    });

    messagesContainer.addEventListener('touchmove', function(e) {
        if (!currentMessageElement) return;

        const touch = e.touches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = Math.abs(touch.clientY - startY);

        // Swipe влево для ответа (мин. 50px по X, макс. 30px по Y)
        if (deltaX < -50 && deltaY < 30) {
            e.preventDefault();
            // Визуальная индикация свайпа
            currentMessageElement.style.transform = `translateX(${Math.max(deltaX, -100)}px)`;
            currentMessageElement.style.opacity = '0.8';
        }
    });

    messagesContainer.addEventListener('touchend', function(e) {
        if (!currentMessageElement) return;

        const touch = e.changedTouches[0];
        const deltaX = touch.clientX - startX;
        const deltaY = Math.abs(touch.clientY - startY);

        // Если свайп влево завершен - активируем ответ
        if (deltaX < -50 && deltaY < 30) {
            const messageId = currentMessageElement.getAttribute('data-message-id');
            const author = currentMessageElement.getAttribute('data-author');
            window.chatClientInstance?.setReplyMode(messageId, author);
        }

        // Возвращаем элемент в исходное положение
        currentMessageElement.style.transform = '';
        currentMessageElement.style.opacity = '';
        currentMessageElement = null;
    });

    // Долгое нажатие для контекстного меню на мобильных
    let longPressTimer;

    messagesContainer.addEventListener('touchstart', function(e) {
        const messageElement = e.target.closest('.message');
        if (!messageElement) return;

        longPressTimer = setTimeout(() => {
            // Имитируем контекстное меню
            const rect = messageElement.getBoundingClientRect();
            const contextMenu = document.getElementById('message-context-menu');

            contextMenu.style.left = rect.left + 'px';
            contextMenu.style.top = rect.bottom + 'px';
            contextMenu.style.display = 'block';

            // Вибрация для тактильной обратной связи
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }, 500); // 500ms долгое нажатие
    });

    messagesContainer.addEventListener('touchend', function() {
        clearTimeout(longPressTimer);
    });

    messagesContainer.addEventListener('touchmove', function() {
        clearTimeout(longPressTimer);
    });
}

// Клавиатурные сокращения
function setupKeyboardShortcuts() {
    document.addEventListener('keydown', function(e) {
        // Escape - отменить режим ответа
        if (e.key === 'Escape') {
            window.chatClientInstance?.cancelReply();
        }

        // Ctrl+R - ответить на последнее сообщение
        if (e.ctrlKey && e.key === 'r') {
            e.preventDefault();
            const lastMessage = document.querySelector('#chat-messages .message:last-child');
            if (lastMessage) {
                const messageId = lastMessage.getAttribute('data-message-id');
                const author = lastMessage.getAttribute('data-author');
                window.chatClientInstance?.setReplyMode(messageId, author);
            }
        }
    });
}

// Вспомогательная функция копирования текста
function copyMessageText(messageId) {
    const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
    if (!messageElement) return;

    const messageContent = messageElement.querySelector('.message-content')?.textContent;
    if (!messageContent) return;

    navigator.clipboard.writeText(messageContent).then(() => {
        // Показываем уведомление об успешном копировании
        if (window.showNotification) {
            window.showNotification('Текст скопирован в буфер обмена', 'info');
        }
    }).catch(() => {
        // Fallback для старых браузеров
        const textArea = document.createElement('textarea');
        textArea.value = messageContent;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);

        if (window.showNotification) {
            window.showNotification('Текст скопирован в буфер обмена', 'info');
        }
    });
}

// Функция-заглушка для закрепления сообщения
function pinMessage(messageId) {
    // Пока просто показываем уведомление
    if (window.showNotification) {
        window.showNotification('Функция закрепления сообщений в разработке', 'info');
    }
    console.log('Pin message:', messageId);
}
</script>
{% endblock %}

{% block footer %}{% endblock %}
