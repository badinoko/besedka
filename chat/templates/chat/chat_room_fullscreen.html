<!-- chat/templates/chat/room.html -->
{% extends "base.html" %}
{% load static %}
{% load chat_extras %}

{% block title %}
{% if room_name == 'general' %}–ë–µ—Å–µ–¥–∫–∞ - –ß–∞—Ç{% elif room_name == 'vip' %}–ë–µ—Å–µ–¥–∫–∞ - VIP{% else %}–ß–∞—Ç: {{ room_name }}{% endif %}
{% endblock %}

{% block extra_css %}
<link href="{% static 'css/chat_styles.css' %}?v=12.0" rel="stylesheet">
{% endblock %}

{% block main_container %}
<div class="chat-container {% if room_name == 'vip' %}vip-chat{% endif %}">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞ -->
    <div class="chat-header {% if room_name == 'vip' %}vip-header{% endif %}">
        <div class="chat-title-section">
            <div class="chat-icon">
                {% if room_name == 'vip' %}
                    <i class="fas fa-crown"></i>
                {% else %}
                    <i class="fas fa-comments"></i>
                {% endif %}
            </div>
            <h1 class="chat-title">
                {% if room_name == 'vip' %}
                    –ë–µ—Å–µ–¥–∫–∞ - VIP
                {% else %}
                    –ë–µ—Å–µ–¥–∫–∞
                {% endif %}
            </h1>
        </div>

        <div class="chat-stats-info">
            <span id="online-count">0</span> —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-body">
        <div class="chat-messages-area">
            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            <div id="chat-messages" class="chat-messages">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                    <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ!</p>
                </div>
            </div>

            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏ -->
            <div id="typing-indicator" class="typing-indicator"></div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ -->
        <div class="users-sidebar">
            <div class="users-header">
                <h3>
                    <i class="fas fa-users me-2"></i>
                    {% if room_name == 'vip' %}VIP –£—á–∞—Å—Ç–Ω–∏–∫–∏{% else %}–£—á–∞—Å—Ç–Ω–∏–∫–∏{% endif %}
                    <span id="online-count-badge" class="badge">0</span>
                </h3>
            </div>
            <div id="online-users-list" class="users-list">
                <div class="text-center text-muted py-3">
                    <i class="fas fa-user-slash mb-2"></i>
                    <p class="small mb-0">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ—Ç–≤–µ—Ç–∞ -->
    <div id="reply-indicator-area" class="reply-indicator" style="display: none;"></div>

    <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
    <div class="chat-input-area">
        <div class="input-group">
            <input id="message-input"
                   type="text"
                   class="form-control"
                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                   autocomplete="off">
            <button id="send-button" class="btn-send">
                <i class="fas fa-paper-plane"></i>
                <span class="d-none d-md-inline ms-2">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
            </button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="chat-stats-panel">
        <div class="stats-content">
            <div class="stat-item">
                <i class="fas fa-message"></i>
                <span>–°–æ–æ–±—â–µ–Ω–∏–π: <span id="messages-count">-</span></span>
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span>–í—Ä–µ–º—è: <span id="current-time">-</span></span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer %}{% endblock %}

{% block extra_scripts %}
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<script src="{% static 'js/unified_notifications.js' %}?v=202506160250"></script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª–∏–µ–Ω—Ç —á–∞—Ç–∞ -->
<script src="{% static 'js/chat_client.js' %}?v=5.0"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–∏–ø–æ–º
    const chatType = '{{ room_name }}';
    window.chatClient = initChat(chatType);

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
    function updateTime() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('ru-RU', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        const timeElement = document.getElementById('current-time');
        if (timeElement) {
            timeElement.textContent = timeString;
        }
    }

    updateTime();
    setInterval(updateTime, 1000);

    // –°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    function updateMessagesCount() {
        const messagesContainer = document.getElementById('chat-messages');
        if (messagesContainer) {
            const messageCount = messagesContainer.querySelectorAll('.message').length;
            const countElement = document.getElementById('messages-count');
            if (countElement) {
                countElement.textContent = messageCount;
            }
        }
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ DOM
    const observer = new MutationObserver(updateMessagesCount);
    const messagesContainer = document.getElementById('chat-messages');
    if (messagesContainer) {
        observer.observe(messagesContainer, { childList: true });
    }

    // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.focus();
    }

    console.log('üöÄ –ö–∞—Å—Ç–æ–º–Ω—ã–π —á–∞—Ç "–ë–µ—Å–µ–¥–∫–∞" –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω!');
    console.log('üìç –¢–∏–ø —á–∞—Ç–∞:', chatType);
    console.log('üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:', '{{ user.display_name }}');
});
</script>
{% endblock %}
