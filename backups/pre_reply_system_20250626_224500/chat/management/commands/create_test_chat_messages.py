from django.core.management.base import BaseCommand
from django.utils import timezone
from datetime import timedelta
from chat.models import Room, Message
from users.models import User

class Command(BaseCommand):
    help = '–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–∞—Ö –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ù–ï —É–¥–∞–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ)'

    def add_arguments(self, parser):
        parser.add_argument(
            '--clear',
            action='store_true',
            help='–û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤—ã—Ö (—Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω–æ–º—É —Ñ–ª–∞–≥—É)',
        )
        parser.add_argument(
            '--count',
            type=int,
            default=15,
            help='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15)',
        )

    def handle(self, *args, **options):
        self.stdout.write(self.style.WARNING("üß™ –°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–´–• –°–û–û–ë–©–ï–ù–ò–ô –ß–ê–¢–ê"))

        # –û—á–∏—Å—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ —è–≤–Ω–æ–º—É —Ñ–ª–∞–≥—É
        if options['clear']:
            Message.objects.all().delete()
            self.stdout.write(self.style.WARNING("üóëÔ∏è –û—á–∏—â–µ–Ω—ã –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è"))
        else:
            existing_count = Message.objects.count()
            self.stdout.write(self.style.SUCCESS(f"üìù –°—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π: {existing_count} (—Å–æ—Ö—Ä–∞–Ω—è–µ–º)"))

        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ª–æ–≥–∏–Ω—ã –∏–∑ BESEDKA_USER_SYSTEM.md
        test_users_data = [
            ('owner', 'üëë –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –ë–µ—Å–µ–¥–∫—É! –ó–¥–µ—Å—å –º—ã –æ–±—Å—É–∂–¥–∞–µ–º –≤—Å–µ —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥—Å—Ç–≤–æ–º.'),
            ('admin', 'üõ°Ô∏è –ö—Å—Ç–∞—Ç–∏, —É –Ω–∞—Å –µ—Å—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ. –û—á–µ–Ω—å —É–¥–æ–±–Ω–æ!'),
            ('store_owner', 'üè™ –°–∫–æ—Ä–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ—Ä—Ç–æ–≤ —Å–µ–º—è–Ω. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!'),
            ('store_admin', 'üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–¥–µ—Ç –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ. –î–æ—Å—Ç–∞–≤–∫–∞ 2-3 –¥–Ω—è.'),
            ('test_user', 'üå± –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è —Ç–æ–º–∞—Ç–æ–≤ –≤ —Ç–µ–ø–ª–∏—Ü–µ!')
        ]

        # –ü–æ–ª—É—á–∞–µ–º –∫–æ–º–Ω–∞—Ç—ã
        try:
            general_room = Room.objects.get(name='general')
            vip_room = Room.objects.get(name='vip')
            self.stdout.write(self.style.SUCCESS("‚úÖ –ö–æ–º–Ω–∞—Ç—ã —á–∞—Ç–æ–≤ –Ω–∞–π–¥–µ–Ω—ã"))
        except Room.DoesNotExist:
            self.stdout.write(self.style.ERROR("‚ùå –ö–æ–º–Ω–∞—Ç—ã —á–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"))
            return

        count_per_user = options['count']
        messages_created = 0

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        message_templates = {
            'owner': [
                'üëë –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –ë–µ—Å–µ–¥–∫—É! –ó–¥–µ—Å—å –º—ã –æ–±—Å—É–∂–¥–∞–µ–º –≤—Å–µ —á—Ç–æ —Å–≤—è–∑–∞–Ω–æ —Å —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥—Å—Ç–≤–æ–º.',
                'üåü –†–∞–¥—ã –≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ!',
                'üèÜ –°–∫–æ—Ä–æ –∑–∞–ø—É—Å—Ç–∏–º –∫–æ–Ω–∫—É—Ä—Å –ª—É—á—à–∏—Ö –≥—Ä–æ—É-—Ä–µ–ø–æ—Ä—Ç–æ–≤ —Å –ø—Ä–∏–∑–∞–º–∏!',
                'üí° –ü—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –∏–¥–µ–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã - –º—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç—ã –∫ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º.',
                'üéØ –ù–∞—à–∞ —Ü–µ–ª—å - —Å–æ–∑–¥–∞—Ç—å –ª—É—á—à–µ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç–µ–Ω–∏–µ–≤–æ–¥–æ–≤ –≤ —Ä—É–Ω–µ—Ç–µ!'
            ],
            'admin': [
                'üõ°Ô∏è –ö—Å—Ç–∞—Ç–∏, —É –Ω–∞—Å –µ—Å—Ç—å —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –Ω–æ–≤–∏—á–∫–æ–≤ –≤ –º–∞–≥–∞–∑–∏–Ω–µ. –û—á–µ–Ω—å —É–¥–æ–±–Ω–æ!',
                '‚ö†Ô∏è –ù–∞–ø–æ–º–∏–Ω–∞—é –æ –ø—Ä–∞–≤–∏–ª–∞—Ö —á–∞—Ç–∞ - –±—É–¥—å—Ç–µ —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω—ã –∫ –¥—Ä—É–≥–∏–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.',
                'üîç –ü—Ä–æ–≤–µ—Ä—è—é –≥–∞–ª–µ—Ä–µ—é –Ω–∞ –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ - –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!',
                'üìã –ï—Å–ª–∏ –∑–∞–º–µ—Ç–∏–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏—è - —Å–æ–æ–±—â–∞–π—Ç–µ –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.',
                'üé≠ –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç 24/7 –¥–ª—è –∫–æ–º—Ñ–æ—Ä—Ç–∞ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.'
            ],
            'store_owner': [
                'üè™ –°–∫–æ—Ä–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ—Ä—Ç–æ–≤ —Å–µ–º—è–Ω. –°–ª–µ–¥–∏—Ç–µ –∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏!',
                'üí∞ –î–µ–π—Å—Ç–≤—É–µ—Ç —Å–∫–∏–¥–∫–∞ 15% –Ω–∞ –≤—Å–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –¥–æ –∫–æ–Ω—Ü–∞ –º–µ—Å—è—Ü–∞!',
                'üì¶ –ù–æ–≤–∞—è –ø–∞—Ä—Ç–∏—è LED-—Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫–æ–≤ –ø–æ—Å—Ç—É–ø–∏–ª–∞ –Ω–∞ —Å–∫–ª–∞–¥.',
                'üéÅ –î–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã.',
                'üöö –†–∞—Å—à–∏—Ä–∏–ª–∏ –∑–æ–Ω—É –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏ - —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–∏–≥–æ—Ä–æ–¥—ã!'
            ],
            'store_admin': [
                'üì¶ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –∏–¥–µ—Ç –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ. –î–æ—Å—Ç–∞–≤–∫–∞ 2-3 –¥–Ω—è.',
                '‚è∞ –í—Å–µ –∑–∞–∫–∞–∑—ã, —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –¥–æ 15:00, –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å.',
                'üìã –ü—Ä–æ–≤–µ—Ä–∏–ª –æ—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ - –≤—Å–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –≤ –Ω–∞–ª–∏—á–∏–∏.',
                'üîÑ –û–±–Ω–æ–≤–∏–ª —Å—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤ - –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.',
                'üìû –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å 9:00 –¥–æ 21:00 –±–µ–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö.'
            ],
            'test_user': [
                'üå± –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –æ–ø—ã—Ç–æ–º –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è —Ç–æ–º–∞—Ç–æ–≤ –≤ —Ç–µ–ø–ª–∏—Ü–µ!',
                'ü§î –ü–æ–¥—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è –ª—É—á—à–µ –¥–ª—è —Ä–∞—Å—Å–∞–¥—ã –ø–µ—Ä—Ü–∞?',
                'üì∏ –ó–∞–≥—Ä—É–∑–∏–ª –Ω–æ–≤—ã–µ —Ñ–æ—Ç–æ —Å–≤–æ–µ–≥–æ –≥—Ä–æ—É-—Ä–µ–ø–æ—Ä—Ç–∞ –≤ –≥–∞–ª–µ—Ä–µ—é.',
                'üåø –ö—Ç–æ-–Ω–∏–±—É–¥—å –ø—Ä–æ–±–æ–≤–∞–ª –≤—ã—Ä–∞—â–∏–≤–∞—Ç—å –º–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –¥–æ–º–∞?',
                'üíß –í–æ–ø—Ä–æ—Å –ø–æ –ø–æ–ª–∏–≤—É: –∫–∞–∫ —á–∞—Å—Ç–æ –ø–æ–ª–∏–≤–∞—Ç—å –º–æ–ª–æ–¥—ã–µ —Ä–∞—Å—Ç–µ–Ω–∏—è?',
                'üå°Ô∏è –ö–∞–∫–∞—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –¥–ª—è –ø—Ä–æ—Ä–∞—â–∏–≤–∞–Ω–∏—è —Å–µ–º—è–Ω?',
                'ü™¥ –ü–æ–∫–∞–∑—ã–≤–∞—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –º–µ—Å—è—Ü–∞ –≤—ã—Ä–∞—â–∏–≤–∞–Ω–∏—è!',
                'üî¨ –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø–æ—á–∏—Ç–∞—Ç—å –ø—Ä–æ –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã –≥–∏–¥—Ä–æ–ø–æ–Ω–∏–∫–∏.',
                'üêõ –°—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å –≤—Ä–µ–¥–∏—Ç–µ–ª—è–º–∏ - –∫–∞–∫ –±–æ—Ä–æ—Ç—å—Å—è —ç–∫–æ–ª–æ–≥–∏—á–Ω–æ?',
                'üèÜ –£—á–∞—Å—Ç–≤—É—é –≤ –∫–æ–Ω–∫—É—Ä—Å–µ - –∂–µ–ª–∞–π—Ç–µ —É–¥–∞—á–∏!'
            ]
        }

        # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        base_time = timezone.now() - timedelta(hours=24)  # –ù–∞—á–∏–Ω–∞–µ–º —Å —Å—É—Ç–æ–∫ –Ω–∞–∑–∞–¥
        time_offset = 0

        for username, default_message in test_users_data:
            try:
                user = User.objects.get(username=username)
                templates = message_templates.get(username, [default_message])

                # –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –æ–±—â–µ–º —á–∞—Ç–µ
                for i in range(count_per_user):
                    message_text = templates[i % len(templates)]
                    message_time = base_time + timedelta(minutes=time_offset)

                    Message.objects.create(
                        room=general_room,
                        author=user,
                        content=message_text,
                        created_at=message_time
                    )
                    time_offset += 3  # 3 –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                    messages_created += 1

                # –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ VIP —á–∞—Ç–µ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞
                if username == 'owner':
                    vip_messages = [
                        'üíé –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ VIP-–∑–æ–Ω—É –Ω–∞—à–µ–π –ë–µ—Å–µ–¥–∫–∏!',
                        'üèÜ –ó–¥–µ—Å—å –º—ã –æ–±—Å—É–∂–¥–∞–µ–º —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ —Å–æ—Ä—Ç–∞ –∏ –ø—Ä–µ–º–∏—É–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏.',
                        'ü§ù VIP-—É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.',
                        'üîí –ö–æ–Ω—Ç–µ–Ω—Ç —ç—Ç–æ–≥–æ —á–∞—Ç–∞ –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.',
                        'üí´ –°–∫–æ—Ä–æ –±—É–¥—É—Ç –∞–Ω–æ–Ω—Å—ã –Ω–æ–≤—ã—Ö VIP-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π!'
                    ]

                    for vip_msg in vip_messages:
                        message_time = base_time + timedelta(minutes=time_offset)
                        Message.objects.create(
                            room=vip_room,
                            author=user,
                            content=vip_msg,
                            created_at=message_time
                        )
                        time_offset += 5  # 5 –º–∏–Ω—É—Ç –º–µ–∂–¥—É VIP —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                        messages_created += 1

                self.stdout.write(self.style.SUCCESS(f"‚úÖ {user.get_role_icon} {username}: —Å–æ–∑–¥–∞–Ω–æ {count_per_user} —Å–æ–æ–±—â–µ–Ω–∏–π"))

            except User.DoesNotExist:
                self.stdout.write(self.style.ERROR(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {username} –Ω–µ –Ω–∞–π–¥–µ–Ω"))

        self.stdout.write(self.style.SUCCESS(f"üéâ –°–û–ó–î–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û! –í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ: {messages_created} —Å–æ–æ–±—â–µ–Ω–∏–π"))
        self.stdout.write(self.style.WARNING("üí° –î–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ –≤ —á–∞—Ç–µ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞!"))
        self.stdout.write(self.style.WARNING("üß™ –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —á–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: http://127.0.0.1:8001/chat/general/"))
