{% extends 'base.html' %}
{% load static %}

{% comment %}
üß™ –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê Rocket.Chat - TELEGRAM HOVER –ö–ù–û–ü–ö–ò
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 26 –∏—é–Ω—è 2025 –≥.
–°—Ç–∞—Ç—É—Å: –î–û–ë–ê–í–õ–ï–ù–´ TELEGRAM HOVER –ö–ù–û–ü–ö–ò - –≠–¢–ê–ü 1 –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç—ã ¬ß2.5
{% endcomment %}

{% block title %}üß™ –ß–∞—Ç (—Ç–µ—Å—Ç) - –ë–µ—Å–µ–¥–∫–∞{% endblock %}

{% block extra_css %}
<style>
    body.chat-page {
        overflow-y: hidden;
    }
    .chat-container {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        background: #1a1a2e;
        display: flex;
        flex-direction: column;
    }
    .chat-container iframe {
        flex: 1;
        width: 100%;
        border: none;
    }
    .test-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(255, 193, 7, 0.9);
        color: black;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 9999;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('chat-page');
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/auto_join_fix.js' %}"></script>
<script>
let isSwitching=false;
function switchChannel(name){
 if(isSwitching)return;isSwitching=true;
 const frame=document.getElementById('rocketchat-iframe');
 const t=Date.now();
 frame.src=`{{ rocketchat_url }}/channel/${name}?layout=embedded&t=${t}`;
 frame.onload=()=>{
   isSwitching=false;
 };
}

window.addEventListener('load',()=>{
 const params=new URLSearchParams(window.location.search);
 const ch=params.get('channel');
 if(ch&&ch!=='general')switchChannel(ch);
 updateChannelNavTitle(ch || 'general');
});

function switchChannelNav(channel) {
 switchChannel(channel);
 updateChannelNavTitle(channel);
 return false;
}

function updateChannelNavTitle(channel) {
 const nameEl = document.getElementById('currentChannelName');
 const buttonEl = document.getElementById('channelDropdownNav');
 if (!nameEl || !buttonEl) return;
 const titles = {'general': '–û–±—â–∏–π', 'vip': 'VIP', 'moderators': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã'};
 nameEl.textContent = titles[channel] || '–û–±—â–∏–π';
 buttonEl.classList.remove('channel-general', 'channel-vip', 'channel-moderators');
 buttonEl.classList.add('channel-' + channel);
}

document.addEventListener('click', function(event) {
 const dropdown = document.getElementById('channelDropdownNav');
 const dropdownMenu = dropdown ? dropdown.nextElementSibling : null;
 if (dropdown && dropdownMenu && !dropdown.contains(event.target) && !dropdownMenu.contains(event.target)) {
   const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
   if (bsDropdown) { bsDropdown.hide(); }
 }
});

document.addEventListener('keydown', function(event) {
 if (event.key === 'Escape') {
   const dropdown = document.getElementById('channelDropdownNav');
   if (dropdown) {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) { bsDropdown.hide(); }
   }
 }
});
</script>
{% endblock %}

{% block main_container %}
    <div class="chat-container">
        <iframe id="rocketChatFrame" src="{{ rocketchat_url }}/channel/general?layout=embedded" allow="camera; microphone; clipboard-write"></iframe>
        <div class="test-indicator">
            üß™ –¢–µ—Å—Ç–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (v3 - Final Clean)
        </div>
    </div>
{% endblock %}

{% block footer %}{% endblock %}
