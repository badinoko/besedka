<!-- chat/templates/chat/room.html -->
{% extends "base.html" %}
{% load static %}
{% load chat_extras %}

{% block title %}
{% if room_name == 'general' %}Беседка - Чат{% elif room_name == 'vip' %}Беседка - VIP{% else %}Чат: {{ room_name }}{% endif %}
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/chat_styles.css' %}?v=12.8">
<style>
    /* Полноэкранный чат без отступов */
    .chat-fullscreen-container {
        position: fixed;
        top: 60px; /* Под навигацией */
        left: 0;
        right: 0;
        bottom: 0;
        background: white;
        display: flex;
        flex-direction: column;
    }

    /* Основная область чата */
    .chat-main-area {
        flex: 1;
        display: flex;
        overflow: hidden;
    }

    /* Область сообщений */
    .chat-messages-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        margin-right: 250px; /* Место для правой панели */
    }

    /* Статистические панели */
    .chat-stats-row {
        display: flex;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid #dee2e6;
        justify-content: space-between;
        align-items: center;
    }

    .stat-item {
        display: flex;
        align-items: center;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .stat-item i {
        margin-right: 0.5rem;
        color: #007bff;
    }

    .stat-value {
        font-weight: 600;
        color: #495057;
        margin-left: 0.25rem;
    }

    /* Область сообщений */
    .chat-messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        background: #f8f9fa;
    }

    /* Индикатор ответа */
    .reply-indicator-area {
        display: none;
        padding: 0.75rem 1rem;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-left: 4px solid #2196f3;
        margin: 0 1rem;
        border-radius: 0.5rem;
        animation: slideInFromTop 0.3s ease-out;
    }

    .reply-indicator-area.active {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .reply-indicator-text {
        font-size: 0.9rem;
        color: #1976d2;
        display: flex;
        align-items: center;
    }

    .reply-indicator-text i {
        margin-right: 0.5rem;
    }

    .cancel-reply-btn {
        background: none;
        border: none;
        color: #1976d2;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        transition: all 0.2s ease;
    }

    .cancel-reply-btn:hover {
        background: rgba(33, 150, 243, 0.1);
        transform: scale(1.1);
    }

    /* Поле ввода с индикатором типизации */
    .chat-input-area {
        padding: 1rem 2rem;
        background: white;
        border-top: 1px solid #e9ecef;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }

    .typing-indicator {
        min-height: 1.5rem;
        padding: 0.25rem 0;
        color: #6c757d;
        font-size: 0.85rem;
        font-style: italic;
    }

    .input-group {
        border-radius: 2rem;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .form-control {
        border: none;
        padding: 1rem 1.5rem;
        font-size: 1rem;
    }

    .form-control:focus {
        box-shadow: none;
        border: none;
    }

    .btn-send {
        background: {% if room_name == 'vip' %}linear-gradient(135deg, #ffd700 0%, #ffb347 100%){% else %}linear-gradient(135deg, #28a745 0%, #20c997 100%){% endif %};
        color: {% if room_name == 'vip' %}#333{% else %}white{% endif %};
        border: none;
        padding: 1rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        color: {% if room_name == 'vip' %}#333{% else %}white{% endif %};
    }

    /* Правая панель */
    .users-sidebar {
        position: fixed;
        top: 60px;
        right: 0;
        width: 250px;
        height: calc(100vh - 60px);
        background: white;
        border-left: 1px solid #e9ecef;
        display: flex;
        flex-direction: column;
    }

    .users-header {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .users-header h6 {
        font-size: 1.6rem !important;
        margin-bottom: 0;
        font-weight: 600;
    }

    .badge {
        background: #007bff;
        color: white;
        padding: 0.5rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.9rem;
    }

    .users-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
    }

    .online-user {
        display: flex;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        background: #28a745;
        border-radius: 50%;
        margin-right: 0.75rem;
    }

    /* Context Menu */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        z-index: 9999;
        min-width: 150px;
        padding: 0.5rem 0;
        display: none;
    }

    .context-menu-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        color: #495057;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
    }

    .context-menu-item:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #007bff;
        transform: translateX(5px);
    }

    .context-menu-item i {
        margin-right: 0.75rem;
        width: 1rem;
        text-align: center;
    }

    /* Mobile gestures */
    .message.swipe-active {
        transform: translateX(-50px);
        transition: transform 0.3s ease;
    }

    .message.long-press-active {
        background: rgba(0, 123, 255, 0.1);
        border-radius: 0.5rem;
    }

    /* Animations */
    @keyframes slideInFromTop {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .chat-messages-container {
            margin-right: 0;
        }

        .users-sidebar {
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .users-sidebar.active {
            transform: translateX(0);
        }
    }
</style>
{% endblock %}

{% block main_container %}
<div class="chat-fullscreen-container">
    <!-- Основная область чата -->
    <div class="chat-main-area">
        <!-- Контейнер сообщений -->
        <div class="chat-messages-container">
            <!-- Статистические панели -->
            <div class="chat-stats-row">
                <div class="stat-item">
                    <i class="fas fa-comments"></i>
                    Сообщений: <span class="stat-value" id="messages-count">0</span>
                </div>
                <div class="stat-item">
                    <i class="fas fa-clock"></i>
                    Последнее: <span class="stat-value" id="last-message-time">--:--</span>
                </div>
            </div>

            <!-- Область сообщений -->
            <div class="chat-messages-area" id="chat-messages-area">
                <div id="chat-messages">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
                        <p>Добро пожаловать в чат! Начните общение.</p>
                    </div>
                </div>
            </div>

            <!-- Индикатор ответа -->
            <div class="reply-indicator-area" id="reply-indicator">
                <div class="reply-indicator-text">
                    <i class="fas fa-reply"></i>
                    <span id="reply-text">В ответ на: @username</span>
                </div>
                <button class="cancel-reply-btn" id="cancel-reply-btn" title="Отменить ответ">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Поле ввода сообщения -->
            <div class="chat-input-area">
                <!-- Индикатор печати -->
                <div class="typing-indicator" id="typing-indicator"></div>

                <div class="input-group">
                    <input id="chat-message-input"
                           type="text"
                           class="form-control"
                           placeholder="Введите сообщение..."
                           autocomplete="off">
                    <button id="chat-message-submit" class="btn btn-send">
                        <i class="fas fa-paper-plane me-1"></i>
                        Отправить
                    </button>
                </div>
            </div>
        </div>

        <!-- Правая панель: список пользователей -->
        <div class="users-sidebar">
            <!-- Заголовок панели -->
            <div class="users-header">
                <h6>Онлайн</h6>
                <span class="badge" id="online-count">0</span>
            </div>

            <!-- Список онлайн пользователей -->
            <div class="users-list" id="users-list">
                <!-- Пользователи загружаются динамически -->
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="context-menu">
    <button class="context-menu-item" data-action="reply">
        <i class="fas fa-reply"></i>
        Ответить
    </button>
    <button class="context-menu-item" data-action="quote">
        <i class="fas fa-quote-right"></i>
        Цитировать
    </button>
    <button class="context-menu-item" data-action="copy">
        <i class="fas fa-copy"></i>
        Копировать
    </button>
</div>

{{ room_name|json_script:"room-name" }}
{{ user.id|json_script:"user-id" }}
{{ user.username|json_script:"user-name" }}

<script src="{% static 'js/chat_client.js' %}?v=5.1"></script>
<script>
    // Инициализация ChatClient v5.1
    document.addEventListener('DOMContentLoaded', function() {
        const roomName = JSON.parse(document.getElementById('room-name').textContent);
        const userId = JSON.parse(document.getElementById('user-id').textContent);
        const userName = JSON.parse(document.getElementById('user-name').textContent);

        const currentUser = {
            id: userId,
            username: userName
        };

        // Создаем экземпляр ChatClient
        window.chatClient = new ChatClient(roomName, currentUser);
        window.chatClient.init();

        // Context Menu Handlers
        const contextMenu = document.getElementById('context-menu');
        let contextMenuTarget = null;

        // Desktop: Right-click context menu
        document.addEventListener('contextmenu', function(e) {
            const messageElement = e.target.closest('.message');
            if (messageElement && !messageElement.classList.contains('own-message')) {
                e.preventDefault();
                contextMenuTarget = messageElement;
                contextMenu.style.display = 'block';
                contextMenu.style.left = e.pageX + 'px';
                contextMenu.style.top = e.pageY + 'px';

                // Add highlight to target message
                messageElement.classList.add('context-menu-target');
            }
        });

        // Hide context menu on click outside
        document.addEventListener('click', function(e) {
            if (!contextMenu.contains(e.target)) {
                contextMenu.style.display = 'none';
                document.querySelectorAll('.context-menu-target').forEach(el => {
                    el.classList.remove('context-menu-target');
                });
                contextMenuTarget = null;
            }
        });

        // Context menu actions
        contextMenu.addEventListener('click', function(e) {
            const action = e.target.closest('.context-menu-item')?.dataset.action;
            if (action && contextMenuTarget) {
                const messageId = contextMenuTarget.dataset.messageId;
                const author = contextMenuTarget.dataset.author;

                switch(action) {
                    case 'reply':
                        window.chatClient.setReplyMode(messageId, author);
                        break;
                    case 'quote':
                        window.chatClient.setQuoteMode(messageId, author);
                        break;
                    case 'copy':
                        const messageText = contextMenuTarget.querySelector('.message-content').textContent;
                        navigator.clipboard.writeText(messageText).then(() => {
                            // Show notification
                            const notification = document.createElement('div');
                            notification.className = 'alert alert-success position-fixed';
                            notification.style.cssText = 'top: 70px; right: 20px; z-index: 10000; animation: fadeInOut 2s ease-in-out;';
                            notification.innerHTML = '<i class="fas fa-check me-2"></i>Сообщение скопировано';
                            document.body.appendChild(notification);
                            setTimeout(() => notification.remove(), 2000);
                        });
                        break;
                }

                // Hide context menu
                contextMenu.style.display = 'none';
                contextMenuTarget.classList.remove('context-menu-target');
                contextMenuTarget = null;
            }
        });

        // Mobile: Swipe gestures
        let startX, startY, startTime;
        let isLongPress = false;
        let longPressTimer;

        document.addEventListener('touchstart', function(e) {
            const messageElement = e.target.closest('.message');
            if (messageElement && !messageElement.classList.contains('own-message')) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                startTime = Date.now();
                isLongPress = false;

                // Start long press detection
                longPressTimer = setTimeout(() => {
                    isLongPress = true;
                    messageElement.classList.add('long-press-active');

                    // Vibrate if available
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }

                    // Show context menu
                    contextMenuTarget = messageElement;
                    const rect = messageElement.getBoundingClientRect();
                    contextMenu.style.display = 'block';
                    contextMenu.style.left = Math.min(rect.left, window.innerWidth - 150) + 'px';
                    contextMenu.style.top = (rect.top - 150) + 'px';
                    messageElement.classList.add('context-menu-target');
                }, 500);
            }
        }, { passive: true });

        document.addEventListener('touchmove', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            const messageElement = e.target.closest('.message');
            if (messageElement && !messageElement.classList.contains('own-message') && !isLongPress) {
                const currentX = e.touches[0].clientX;
                const deltaX = startX - currentX;

                if (deltaX > 30) { // Swipe left threshold
                    messageElement.classList.add('swipe-active');
                }
            }
        }, { passive: true });

        document.addEventListener('touchend', function(e) {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }

            const messageElement = e.target.closest('.message');
            if (messageElement) {
                if (messageElement.classList.contains('swipe-active') && !isLongPress) {
                    // Quick reply on swipe left
                    const messageId = messageElement.dataset.messageId;
                    const author = messageElement.dataset.author;
                    window.chatClient.setReplyMode(messageId, author);
                }

                // Clean up classes
                messageElement.classList.remove('swipe-active', 'long-press-active');
            }

            isLongPress = false;
        }, { passive: true });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to cancel reply
            if (e.key === 'Escape') {
                window.chatClient.cancelReply();
            }

            // Ctrl+R to reply to last message
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                const lastMessage = document.querySelector('.message:not(.own-message):last-child');
                if (lastMessage) {
                    const messageId = lastMessage.dataset.messageId;
                    const author = lastMessage.dataset.author;
                    window.chatClient.setReplyMode(messageId, author);
                }
            }
        });

        // Update last message time periodically
        setInterval(() => {
            const lastTimeElement = document.getElementById('last-message-time');
            const lastMessage = document.querySelector('.message:last-child .message-time');
            if (lastMessage && lastTimeElement) {
                lastTimeElement.textContent = lastMessage.textContent;
            }
        }, 30000); // Update every 30 seconds
    });

    // CSS for notifications
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        .context-menu-target {
            background: rgba(0, 123, 255, 0.1) !important;
            border-left: 3px solid #007bff !important;
            border-radius: 0.5rem !important;
        }
    `;
    document.head.appendChild(style);
</script>
{% endblock %}

{% block footer %}{% endblock %}
