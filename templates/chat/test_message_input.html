<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-form {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b3d7ff;
        }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Rocket.Chat</h1>

    <div class="info">
        <h3>üìä –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h3>
        <p><strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong> {{ user.username }}</p>
        <p><strong>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</strong> {{ user_id }}</p>
        <p><strong>–†–æ–ª—å:</strong> {{ user.role }}</p>
        <p><strong>Rocket.Chat URL:</strong> {{ rocketchat_url }}</p>
    </div>

    <div class="test-form">
        <h3>üìù –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h3>
        <form method="post" id="testForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="channel">–ö–∞–Ω–∞–ª:</label>
                <select name="channel" id="channel">
                    <option value="general">general (–û—Å–Ω–æ–≤–Ω–æ–π –∫–∞–Ω–∞–ª)</option>
                    <option value="vip">vip (VIP –∫–∞–Ω–∞–ª)</option>
                    <option value="moderators">moderators (–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="message">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                <textarea name="message" id="message" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">–¢–µ—Å—Ç –ø–æ–ª—è –≤–≤–æ–¥–∞ - {{ user.username }} - {{ timestamp }}</textarea>
            </div>

            <button type="submit">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        </form>
    </div>

    {% if test_result %}
    <div class="result {{ test_result.status }}">
        <h3>üìã –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞:</h3>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ test_result.message }}</p>
        {% if test_result.details %}
        <p><strong>–î–µ—Ç–∞–ª–∏:</strong> {{ test_result.details }}</p>
        {% endif %}
        {% if test_result.mongo_result %}
        <p><strong>MongoDB —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> {{ test_result.mongo_result }}</p>
        {% endif %}
    </div>
    {% endif %}

    <div class="info">
        <h3>üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="{{ rocketchat_url }}" target="_blank">Rocket.Chat –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ</a></li>
            <li>–í–æ–π–¥–∏—Ç–µ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "owner"</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</li>
            <li>–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—è–≤–∏–ª–æ—Å—å - –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ</li>
        </ol>
    </div>

    <script>
        document.getElementById('testForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.text())
            .then(html => {
                document.body.innerHTML = html;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
            });
        });
    </script>
</body>
</html>
