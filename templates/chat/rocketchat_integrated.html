{% extends 'base.html' %}
{% load static %}

{% comment %}
Rocket.Chat Интегрированная страница
Последнее обновление: 22 июня 2025 г., 23:50 MSK
Статус: ИСПРАВЛЕН маппинг каналов для унификации
{% endcomment %}

{% block title %}Чат - Беседка{% endblock %}

{# --- ДОПОЛНИТЕЛЬНЫЕ СТИЛИ ТОЛЬКО ДЛЯ ЧАТА (без переопределения навигации) --- #}
{% block extra_css %}
<style>
    /* Стили для body только для чата */
    body.chat-page {
        overflow-y: hidden; /* Вся прокрутка в html, nav не смещается */
    }

    .chat-container {
        position: fixed;
        top: 60px;   /* высота navbar */
        left: 0;
        right: 0;
        bottom: 0;
        background: #1a1a2e;
        display: flex;
        flex-direction: column;
    }

    .chat-container iframe {
        flex: 1;
        width: 100%;
        border: none;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('chat-page');
});
</script>
{% endblock %}

{# --- JS --- #}
{% block extra_js %}
<script src="{% static 'js/auto_join_fix.js' %}"></script>
<script>
let isSwitching=false;
function switchChannel(name){
 if(isSwitching)return;isSwitching=true;
 const frame=document.getElementById('rocketChatFrame');
 const t=Date.now();
 frame.src=`{{ rocketchat_url }}/channel/${name}?layout=embedded&t=${t}`;
 frame.onload=()=>{
   isSwitching=false;
   // Убираем символы # после загрузки нового канала
   setTimeout(() => removeHashSymbols(), 1000);
 };
}

window.addEventListener('load',()=>{
 const params=new URLSearchParams(window.location.search);
 const ch=params.get('channel');
 if(ch&&ch!=='general')switchChannel(ch);

 // Обновляем название канала в навигации при загрузке
 updateChannelNavTitle(ch || 'general');

 // Убираем символы # после первоначальной загрузки
 setTimeout(() => removeHashSymbols(), 2000);
});

// Новая функция для переключения каналов из навигации
function switchChannelNav(channel) {
 switchChannel(channel);
 updateChannelNavTitle(channel);
 return false; // предотвращаем переход по ссылке
}

// Обновление названия канала в навигации
function updateChannelNavTitle(channel) {
 const nameEl = document.getElementById('currentChannelName');
 const buttonEl = document.getElementById('channelDropdownNav');
 if (!nameEl || !buttonEl) return;

 const titles = {
   'general': 'Общий',
   'vip': 'VIP',
   'moderators': 'Модераторы'
 };

 // Обновляем текст БЕЗ символа #
 nameEl.textContent = titles[channel] || 'Общий';

 // Обновляем цвет кнопки - убираем старые классы и добавляем новый
 buttonEl.classList.remove('channel-general', 'channel-vip', 'channel-moderators');
 buttonEl.classList.add('channel-' + channel);
}

// НОВАЯ ФУНКЦИЯ: Удаление символов # из iframe Rocket.Chat
function removeHashSymbols() {
 const iframe = document.getElementById('rocketChatFrame');
 if (!iframe || !iframe.contentWindow) return;

 try {
   // Попытка доступа к содержимому iframe (может не сработать из-за CORS)
   const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
   if (!iframeDoc) return;

   // Находим все элементы с названиями каналов и убираем символ #
   const selectors = [
     '[data-qa="room-title"]',
     '.rcx-sidebar-item__title',
     '.room-title',
     '.sidebar-item__title',
     '.rc-room-header-title'
   ];

   selectors.forEach(selector => {
     const elements = iframeDoc.querySelectorAll(selector);
     elements.forEach(el => {
       if (el.textContent && el.textContent.startsWith('#')) {
         el.textContent = el.textContent.substring(1); // Убираем первый символ #
       }
     });
   });

 } catch (error) {
   // CORS блокирует доступ - используем альтернативный метод через CSS injection
   console.log('CORS blocked, using CSS injection method');

   // Инжектируем CSS прямо в iframe
   const style = iframe.contentDocument?.createElement('style') || document.createElement('style');
   style.textContent = `
     [data-qa="room-title"]::before,
     .rcx-sidebar-item__title::before,
     .room-title::before,
     .sidebar-item__title::before {
       display: none !important;
     }
     [data-qa="room-title"]:first-letter,
     .rcx-sidebar-item__title:first-letter,
     .room-title:first-letter,
     .sidebar-item__title:first-letter {
       font-size: 0 !important;
       width: 0 !important;
       display: none !important;
     }
   `;

   if (iframe.contentDocument) {
     iframe.contentDocument.head?.appendChild(style);
   }
 }
}

// Закрытие dropdown при клике в любое место экрана (усиленная версия)
document.addEventListener('click', function(event) {
 const dropdown = document.getElementById('channelDropdownNav');
 const dropdownMenu = dropdown ? dropdown.nextElementSibling : null;

 // Если клик не по dropdown и не по его меню - закрываем
 if (dropdown && dropdownMenu &&
     !dropdown.contains(event.target) &&
     !dropdownMenu.contains(event.target)) {

   // Закрываем dropdown через Bootstrap API
   const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
   if (bsDropdown) {
     bsDropdown.hide();
   }
 }
});

// Закрываем dropdown по клавише Escape
document.addEventListener('keydown', function(event) {
 if (event.key === 'Escape') {
   const dropdown = document.getElementById('channelDropdownNav');
   if (dropdown) {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) {
       bsDropdown.hide();
     }
   }
 }
});

// Дополнительно закрываем dropdown при потере фокуса или клике на iframe
document.addEventListener('DOMContentLoaded', function() {
 const dropdown = document.getElementById('channelDropdownNav');
 const iframe = document.getElementById('rocketChatFrame');

 if (dropdown && iframe) {
   // Закрываем dropdown при клике на iframe
   iframe.addEventListener('mousedown', function() {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) {
       bsDropdown.hide();
     }
   });

   // Закрываем dropdown при потере фокуса
   dropdown.addEventListener('blur', function() {
     setTimeout(function() {
       const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
       if (bsDropdown) {
         bsDropdown.hide();
       }
     }, 150);
   });

   // Убираем символы # когда iframe полностью загрузился
   iframe.addEventListener('load', function() {
     setTimeout(() => removeHashSymbols(), 1500);
   });
 }
});
</script>
{% endblock %}

{# --- ГЛАВНЫЙ КОНТЕНТ --- #}
{% block main_container %}
    <div class="chat-container">
        <iframe id="rocketChatFrame" src="{{ rocketchat_url }}/channel/general?layout=embedded" allow="camera; microphone; clipboard-write"></iframe>
    </div>
{% endblock %}

{# --- Убираем стандартный футер --- #}
{% block footer %}{% endblock %}
