{% extends 'base.html' %}
{% load static %}

{% comment %}
üß™ –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–´–ô –¢–ï–°–¢–û–í–´–ô –®–ê–ë–õ–û–ù –¥–ª—è Rocket.Chat Reply/Quote
–¶–µ–ª—å: –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ ¬ß2.1 Reply/Quote —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
–°—Ç–∞—Ç—É—Å: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω - —Ç–µ–ø–µ—Ä—å –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 25 –∏—é–Ω—è 2025 –≥.
{% endcomment %}

{% block title %}Rocket.Chat Test | Channel: {{ current_channel }}{% endblock %}

{# --- –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –°–¢–ò–õ–ò –¢–û–õ–¨–ö–û –î–õ–Ø –ß–ê–¢–ê (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) --- #}
{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è body —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–∞ */
    body.chat-page {
        overflow-y: hidden; /* –í—Å—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤ html, nav –Ω–µ —Å–º–µ—â–∞–µ—Ç—Å—è */
    }

    .chat-container {
        position: fixed;
        top: 60px;   /* –≤—ã—Å–æ—Ç–∞ navbar */
        left: 0;
        right: 0;
        bottom: 0;
        background: #1a1a2e;
        display: flex;
        flex-direction: column;
    }

    .chat-container iframe {
        flex: 1;
        width: 100%;
        border: none;
    }

    /* üß™ –¢–ï–°–¢–û–í–´–ô –ò–ù–î–ò–ö–ê–¢–û–†: —É–±—Ä–∞–Ω –ø–æ –ø—Ä–æ—Å—å–±–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('chat-page');
});
</script>
{% endblock %}

{# --- –¢–ï–°–¢–û–í–´–ô JAVASCRIPT (—Ç–æ–ª—å–∫–æ –¥–ª—è Reply/Quote –≤ iframe) --- #}
{% block extra_js %}
<script src="{% static 'js/auto_join_fix.js' %}"></script>
<script>
// üß™ –û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ –ß–ê–¢–ê (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
let isSwitching=false;
function switchChannel(name){
 if(isSwitching)return;isSwitching=true;
 const frame=document.getElementById('testRocketChatFrame');
 const t=Date.now();
 frame.src=`{{ rocketchat_url }}/channel/${name}?layout=embedded&t=${t}`;
 frame.onload=()=>{
   isSwitching=false;

   // üß™ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –ü–†–ò–ú–ï–ù–Ø–ï–ú REPLY/QUOTE –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–æ–≤
   setTimeout(() => {
       if (replyQuoteEnabled) {
           console.log('üß™ TEST: –ü—Ä–∏–º–µ–Ω—è—é Reply/Quote –∫ –∫–∞–Ω–∞–ª—É', name);
           injectReplyQuoteFeatures();
       }
   }, 2000);
 };
}

window.addEventListener('load',()=>{
 const params=new URLSearchParams(window.location.search);
 const ch=params.get('channel');
 if(ch&&ch!=='general')switchChannel(ch);

 // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
 updateChannelNavTitle(ch || 'general');

 // üß™ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò –í–ö–õ–Æ–ß–ê–ï–ú REPLY/QUOTE –ß–ï–†–ï–ó 3 –°–ï–ö–£–ù–î–´
 setTimeout(() => {
     console.log('üß™ TEST: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ Reply/Quote...');
     toggleReplyQuote();
 }, 3000);
});

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π)
function switchChannelNav(channel) {
 switchChannel(channel);
 updateChannelNavTitle(channel);
 return false;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π)
function updateChannelNavTitle(channel) {
 const nameEl = document.getElementById('currentChannelName');
 const buttonEl = document.getElementById('channelDropdownNav');
 if (!nameEl || !buttonEl) return;

 const titles = {
   'general': '–û–±—â–∏–π',
   'vip': 'VIP',
   'moderators': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã'
 };

 nameEl.textContent = titles[channel] || '–û–±—â–∏–π';
 buttonEl.classList.remove('channel-general', 'channel-vip', 'channel-moderators');
 buttonEl.classList.add('channel-' + channel);
}

// üß™ REPLY/QUOTE –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨
let replyQuoteEnabled = false;

// üß™ –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –í–Ω–µ–¥—Ä–µ–Ω–∏–µ Reply/Quote –≤ Rocket.Chat iframe
function injectReplyQuoteFeatures() {
    const iframe = document.getElementById('testRocketChatFrame');

    try {
        const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

        if (iframeDocument) {
            console.log('üß™ TEST: –ü—Ä–∏–º–µ–Ω—è—é Reply/Quote —á–µ—Ä–µ–∑ DOM –¥–æ—Å—Ç—É–ø');
            injectReplyQuoteViaDom(iframeDocument);
        } else {
            console.log('üß™ TEST: CORS –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –ø—Ä–∏–º–µ–Ω—è—é —á–µ—Ä–µ–∑ Custom CSS');
            // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å FINAL_ROCKETCHAT_FIX.js
        }
    } catch (error) {
        console.log('üß™ TEST: –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º Custom CSS –ø–æ–¥—Ö–æ–¥');
    }
}

// –í–Ω–µ–¥—Ä–µ–Ω–∏–µ Reply/Quote –∫–Ω–æ–ø–æ–∫ —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π DOM –¥–æ—Å—Ç—É–ø
function injectReplyQuoteViaDom(iframeDoc) {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –∏–∑ chat_styles.css –∫ Rocket.Chat
    const style = iframeDoc.createElement('style');
    style.textContent = `
        /* === üß™ –¢–ï–°–¢–û–í–´–ï REPLY/QUOTE –°–¢–ò–õ–ò - –ò–ù–¢–ï–ì–†–ê–¶–ò–Ø –° CHAT_STYLES.CSS === */
        .rcx-message {
            position: relative !important;
        }

        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –º–µ–Ω—é Reply/Quote —Å –º–æ–±–∏–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π */
        .rcx-message:hover .reply-quote-menu,
        .rcx-message.mobile-selected .reply-quote-menu {
            display: flex !important;
            position: absolute;
            top: -40px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            border-radius: 12px;
            padding: 8px;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* –ö–Ω–æ–ø–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º */
        .reply-btn, .quote-btn {
            color: white;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            min-height: 40px;
            min-width: 80px;
            justify-content: center;
        }

        /* Hover —ç—Ñ—Ñ–µ–∫—Ç—ã —Å —Ü–≤–µ—Ç–æ–≤–æ–π –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞—Ü–∏–µ–π */
        .reply-btn:hover {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-color: #007bff;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.5);
        }

        .quote-btn:hover {
            background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%);
            border-color: #6f42c1;
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(111, 66, 193, 0.5);
        }

        /* === üì± –ú–û–ë–ò–õ–¨–ù–ê–Ø –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø (Roadmap ¬ß2.2) === */
        @media (max-width: 768px) {
            .reply-quote-menu {
                top: -50px !important;
                right: 5px !important;
                padding: 12px !important;
                gap: 12px !important;
                border-radius: 16px !important;
            }

            .reply-btn, .quote-btn {
                padding: 12px 20px !important;
                font-size: 14px !important;
                min-height: 48px !important;
                min-width: 100px !important;
                border-radius: 12px !important;
            }

            /* –ñ–µ—Å—Ç–æ–≤–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ - –≤–∏–∑—É–∞–ª—å–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
            .rcx-message {
                position: relative !important;
                padding: 16px !important;
                margin: 8px 0 !important;
            }

            .rcx-message::before {
                content: '';
                position: absolute;
                left: 0;
                top: 50%;
                transform: translateY(-50%);
                width: 4px;
                height: 0;
                background: linear-gradient(45deg, #007bff, #6f42c1);
                border-radius: 2px;
                transition: height 0.3s ease;
            }

            .rcx-message:active::before,
            .rcx-message.touch-active::before {
                height: 60%;
            }
        }

        /* === üé® –í–ò–ó–£–ê–õ–¨–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –û–¢–í–ï–¢–û–í === */
        /* –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å—Ç–∏–ª—è–º–∏ reply-highlighted –∏–∑ chat_styles.css */
        .rcx-message.reply-highlighted {
            animation: replyHighlight 3s ease-out forwards !important;
            border-left: 6px solid #007bff !important;
            background: linear-gradient(90deg, rgba(0,123,255,0.15) 0%, transparent 100%) !important;
            padding-left: 16px !important;
        }

        .rcx-message.quote-highlighted {
            animation: quoteHighlight 3s ease-out forwards !important;
            border-left: 6px solid #6f42c1 !important;
            background: linear-gradient(90deg, rgba(111,66,193,0.15) 0%, transparent 100%) !important;
            padding-left: 16px !important;
        }

        /* –¶–∏—Ç–∏—Ä—É–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –æ—Ç–≤–µ—Ç–µ */
        .quoted-message {
            background: rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-left: 4px solid #6f42c1;
            font-size: 0.9rem;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .quoted-message::before {
            content: "üí¨";
            position: absolute;
            top: -6px;
            left: -8px;
            background: #6f42c1;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }

        .quote-author {
            font-weight: 600;
            color: #6f42c1;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .quote-text {
            color: #555;
            line-height: 1.4;
            max-height: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* === üìä –°–ß–ï–¢–ß–ò–ö–ò –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø === */
        .message-counter {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #007bff 0%, #6f42c1 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .message-counter.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* === üîî –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –î–ï–ô–°–¢–í–ò–Ø–• === */
        .action-notification {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .action-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .action-notification.reply {
            border-left: 4px solid #007bff;
        }

        .action-notification.quote {
            border-left: 4px solid #6f42c1;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes replyHighlight {
            0% {
                background: linear-gradient(90deg, rgba(0,123,255,0.3) 0%, transparent 100%);
                transform: scale(1.02);
            }
            50% {
                background: linear-gradient(90deg, rgba(0,123,255,0.2) 0%, transparent 100%);
            }
            100% {
                background: linear-gradient(90deg, rgba(0,123,255,0.1) 0%, transparent 100%);
                transform: scale(1);
            }
        }

        @keyframes quoteHighlight {
            0% {
                background: linear-gradient(90deg, rgba(111,66,193,0.3) 0%, transparent 100%);
                transform: scale(1.02);
            }
            50% {
                background: linear-gradient(90deg, rgba(111,66,193,0.2) 0%, transparent 100%);
            }
            100% {
                background: linear-gradient(90deg, rgba(111,66,193,0.1) 0%, transparent 100%);
                transform: scale(1);
            }
        }
    `;
    iframeDoc.head.appendChild(style);

    // === üì± –ú–û–ë–ò–õ–¨–ù–´–ï –ñ–ï–°–¢–´ (Roadmap ¬ß2.3) ===
    let isMobile = window.innerWidth <= 768;
    let touchStartX = 0;
    let touchStartY = 0;
    let touchStartTime = 0;
    let longPressTimer = null;
    let selectedMessage = null;

    // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∫ —Å–æ–æ–±—â–µ–Ω–∏—è–º
    function addReplyQuoteButtons(messageEl) {
        if (messageEl.querySelector('.reply-quote-menu')) return;

        const menu = iframeDoc.createElement('div');
        menu.className = 'reply-quote-menu';

        const replyBtn = iframeDoc.createElement('button');
        replyBtn.className = 'reply-btn';
        replyBtn.innerHTML = '‚Ü©Ô∏è Reply';
        replyBtn.onclick = () => testReplyToMessage(messageEl);

        const quoteBtn = iframeDoc.createElement('button');
        quoteBtn.className = 'quote-btn';
        quoteBtn.innerHTML = 'üí¨ Quote';
        quoteBtn.onclick = () => testQuoteMessage(messageEl);

        menu.appendChild(replyBtn);
        menu.appendChild(quoteBtn);
        messageEl.appendChild(menu);

        // === üì± –ú–û–ë–ò–õ–¨–ù–´–ï –ñ–ï–°–¢–´ ===
        if (isMobile) {
            // –î–ª–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–µ–Ω—é
            messageEl.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();

                longPressTimer = setTimeout(() => {
                    messageEl.classList.add('mobile-selected');
                    navigator.vibrate && navigator.vibrate(50); // Haptic feedback
                    showMobileActionNotification('üì± –î–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ: –º–µ–Ω—é –¥–µ–π—Å—Ç–≤–∏–π –∞–∫—Ç–∏–≤–Ω–æ');
                }, 500);
            });

            messageEl.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
                setTimeout(() => {
                    messageEl.classList.remove('mobile-selected');
                }, 3000);
            });

            messageEl.addEventListener('touchmove', (e) => {
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;

                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–≤–∞–π–ø–Ω—É–ª - –æ—Ç–º–µ–Ω—è–µ–º –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
                if (Math.abs(deltaX) > 10 || Math.abs(deltaY) > 10) {
                    clearTimeout(longPressTimer);
                }

                // –°–≤–∞–π–ø –≤–ª–µ–≤–æ - Reply
                if (deltaX < -80 && Math.abs(deltaY) < 50) {
                    e.preventDefault();
                    testReplyToMessage(messageEl);
                    messageEl.style.transform = 'translateX(-20px)';
                    setTimeout(() => messageEl.style.transform = '', 300);
                }

                // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ - Quote
                if (deltaX > 80 && Math.abs(deltaY) < 50) {
                    e.preventDefault();
                    testQuoteMessage(messageEl);
                    messageEl.style.transform = 'translateX(20px)';
                    setTimeout(() => messageEl.style.transform = '', 300);
                }
            });
        }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è–º
    setTimeout(() => {
        const messages = iframeDoc.querySelectorAll('.rcx-message, .message');
        console.log(`üß™ TEST: –ù–∞–π–¥–µ–Ω–æ ${messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π`);
        messages.forEach(addReplyQuoteButtons);

        updateTestIndicator(messages.length > 0 ? 'ACTIVE' : 'WAITING');
        updateMessageCounter(messages.length);
    }, 1000);

    // MutationObserver –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
                if (node.nodeType === 1) {
                    if (node.classList && (node.classList.contains('rcx-message') || node.classList.contains('message'))) {
                        addReplyQuoteButtons(node);
                    }
                    const innerMessages = node.querySelectorAll && node.querySelectorAll('.rcx-message, .message');
                    if (innerMessages) {
                        innerMessages.forEach(addReplyQuoteButtons);
                    }
                }
            });
        });

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
        const totalMessages = iframeDoc.querySelectorAll('.rcx-message, .message').length;
        updateMessageCounter(totalMessages);
    });

    observer.observe(iframeDoc.body, { childList: true, subtree: true });
    console.log('üß™ TEST: Reply/Quote —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å –º–æ–±–∏–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π');
}

// === üì± –ú–û–ë–ò–õ–¨–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
function showMobileActionNotification(message) {
    const existing = document.querySelector('.mobile-action-notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = 'action-notification mobile-action-notification show';
    notification.innerHTML = `<i class="fas fa-mobile-alt"></i> ${message}`;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
    }, 2000);
}

// –¢–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Reply/Quote —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
function testReplyToMessage(messageElement) {
    const messageData = extractMessageData(messageElement);
    console.log(`üß™ REPLY: ${messageData.author}: "${messageData.text}"`);

    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    messageElement.classList.add('reply-highlighted');
    setTimeout(() => messageElement.classList.remove('reply-highlighted'), 3000);

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
    showTestNotification('reply', `–û—Ç–≤–µ—Ç –Ω–∞: ${messageData.author}`, messageData.text.substring(0, 50) + '...');

    // üéØ –ë–£–î–£–©–ï–ï: –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API Rocket.Chat –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
}

function testQuoteMessage(messageElement) {
    const messageData = extractMessageData(messageElement);
    console.log(`üß™ QUOTE: ${messageData.author}: "${messageData.text}"`);

    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    messageElement.classList.add('quote-highlighted');
    setTimeout(() => messageElement.classList.remove('quote-highlighted'), 3000);

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏
    showTestNotification('quote', `–¶–∏—Ç–∞—Ç–∞: ${messageData.author}`, messageData.text.substring(0, 50) + '...');

    // üéØ –ë–£–î–£–©–ï–ï: –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å API Rocket.Chat –¥–ª—è —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
}

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function extractMessageData(messageElement) {
    const selectors = {
        text: ['.rcx-message__content', '.message-text', '.markup', '.rcx-message-body'],
        author: ['.rcx-username', '.username', '.message-author', '.rcx-message__username'],
        time: ['.rcx-message__time', '.timestamp', '.message-time', '.rcx-message__timestamp']
    };

    let messageText = '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω';
    let author = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
    let time = '–í—Ä–µ–º—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

    // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    for (const selector of selectors.text) {
        const el = messageElement.querySelector(selector);
        if (el && el.textContent.trim()) {
            messageText = el.textContent.trim();
            break;
        }
    }

    for (const selector of selectors.author) {
        const el = messageElement.querySelector(selector);
        if (el && el.textContent.trim()) {
            author = el.textContent.trim();
            break;
        }
    }

    for (const selector of selectors.time) {
        const el = messageElement.querySelector(selector);
        if (el) {
            time = el.textContent.trim() || el.getAttribute('title') || '–ù–µ–¥–∞–≤–Ω–æ';
            if (time) break;
        }
    }

    return { text: messageText, author: author, time: time };
}

// –£–ª—É—á—à–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showTestNotification(type, title, content = '') {
    console.log(`üß™ ${type.toUpperCase()}: ${title} - ${content}`);

    // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const existing = document.querySelector('.action-notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.className = `action-notification ${type} show`;

    const icon = type === 'reply' ? '‚Ü©Ô∏è' : 'üí¨';
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">${icon}</span>
            <div>
                <div style="font-weight: 600;">${title}</div>
                ${content ? `<div style="font-size: 12px; opacity: 0.8;">${content}</div>` : ''}
            </div>
        </div>
    `;

    document.body.appendChild(notification);

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 400);
    }, 3000);

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
    updateTestIndicator(`${type.toUpperCase()}: –∞–∫—Ç–∏–≤–Ω–æ`);
    setTimeout(() => updateTestIndicator('ACTIVE'), 2000);
}

// === üìä –°–ß–ï–¢–ß–ò–ö –°–û–û–ë–©–ï–ù–ò–ô ===
function updateMessageCounter(count) {
    let counter = document.querySelector('.message-counter');
    if (!counter) {
        counter = document.createElement('div');
        counter.className = 'message-counter';
        document.body.appendChild(counter);
    }

    counter.textContent = `üìä –°–æ–æ–±—â–µ–Ω–∏–π: ${count}`;
    counter.classList.add('show');

    // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        counter.classList.remove('show');
    }, 3000);
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ (—É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function updateTestIndicator(status) {
    const indicator = document.querySelector('.test-indicator');
    if (indicator) {
        const icon = status.includes('Reply') ? '‚Ü©Ô∏è' :
                    status.includes('Quote') ? 'üí¨' :
                    status === 'ACTIVE' ? 'üéØ' :
                    status === 'ENABLED' ? '‚úÖ' : 'üß™';

        indicator.innerHTML = `${icon} Reply/Quote: ${status}`;

        if (status.includes('Reply') || status.includes('Quote')) {
            indicator.classList.add('reply-active');
            setTimeout(() => indicator.classList.remove('reply-active'), 2000);
        }
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
function toggleReplyQuote() {
    replyQuoteEnabled = !replyQuoteEnabled;

    if (replyQuoteEnabled) {
        console.log('üß™ TEST: Reply/Quote –í–ö–õ–Æ–ß–ï–ù —Å –º–æ–±–∏–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π');
        injectReplyQuoteFeatures();
        updateTestIndicator('ENABLED');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        showTestNotification('reply', 'üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω', 'Reply/Quote —Å –º–æ–±–∏–ª—å–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –≤–∫–ª—é—á–µ–Ω');
    } else {
        console.log('üß™ TEST: Reply/Quote –û–¢–ö–õ–Æ–ß–ï–ù');
        updateTestIndicator('DISABLED');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)
document.addEventListener('click', function(event) {
 const dropdown = document.getElementById('channelDropdownNav');
 const dropdownMenu = dropdown ? dropdown.nextElementSibling : null;

 if (dropdown && dropdownMenu &&
     !dropdown.contains(event.target) &&
     !dropdownMenu.contains(event.target)) {
   const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
   if (bsDropdown) bsDropdown.hide();
 }
});

document.addEventListener('keydown', function(event) {
 if (event.key === 'Escape') {
   const dropdown = document.getElementById('channelDropdownNav');
   if (dropdown) {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) bsDropdown.hide();
   }
 }
});

document.addEventListener('DOMContentLoaded', function() {
 const dropdown = document.getElementById('channelDropdownNav');
 const iframe = document.getElementById('testRocketChatFrame');

 if (dropdown && iframe) {
   iframe.addEventListener('mousedown', function() {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) bsDropdown.hide();
   });

   dropdown.addEventListener('blur', function() {
     setTimeout(function() {
       const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
       if (bsDropdown) bsDropdown.hide();
     }, 150);
   });
 }
});
</script>
{% endblock %}

{# --- –ì–õ–ê–í–ù–´–ô –ö–û–ù–¢–ï–ù–¢ (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) --- #}
{% block main_container %}
    <div class="chat-container">
        <iframe id="testRocketChatFrame" src="{{ rocketchat_url }}/channel/general?layout=embedded" allow="camera; microphone; clipboard-write"></iframe>
    </div>
{% endblock %}

{# --- –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ—É—Ç–µ—Ä --- #}
{% block footer %}{% endblock %}
