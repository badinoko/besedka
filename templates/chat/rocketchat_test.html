{% extends 'base.html' %}
{% load static %}

{% comment %}
üß™ –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê Rocket.Chat - TELEGRAM HOVER –ö–ù–û–ü–ö–ò
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 26 –∏—é–Ω—è 2025 –≥.
–°—Ç–∞—Ç—É—Å: –î–û–ë–ê–í–õ–ï–ù–´ TELEGRAM HOVER –ö–ù–û–ü–ö–ò - –≠–¢–ê–ü 1 –¥–æ—Ä–æ–∂–Ω–æ–π –∫–∞—Ä—Ç—ã ¬ß2.5
{% endcomment %}

{% block title %}üß™ –ß–∞—Ç (—Ç–µ—Å—Ç) - –ë–µ—Å–µ–¥–∫–∞{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –°–¢–ò–õ–ï–ô –ò–ó INTEGRATED --- #}
{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è body —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–∞ */
    body.chat-page {
        overflow-y: hidden; /* –í—Å—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤ html, nav –Ω–µ —Å–º–µ—â–∞–µ—Ç—Å—è */
    }

    .chat-container {
        position: fixed;
        top: 60px;   /* –≤—ã—Å–æ—Ç–∞ navbar */
        left: 0;
        right: 0;
        bottom: 0;
        background: #1a1a2e;
        display: flex;
        flex-direction: column;
    }

    .chat-container iframe {
        flex: 1;
        width: 100%;
        border: none;
    }

    /* –ú–ê–õ–ï–ù–¨–ö–ò–ô –¢–ï–°–¢–û–í–´–ô –ò–ù–î–ò–ö–ê–¢–û–† */
    .test-indicator {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(40, 167, 69, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 12px;
        z-index: 9999;
        font-weight: 500;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* üéØ REPLY MODE OVERLAY - –ù–ê–î–°–¢–†–û–ô–ö–ê –ù–ê–î –ü–û–õ–ï–ú –í–í–û–î–ê */
    .reply-mode-overlay {
        position: fixed;
        bottom: 80px;
        left: 20px;
        right: 20px;
        background: rgba(0, 123, 255, 0.95);
        color: white;
        padding: 12px 20px;
        border-radius: 10px;
        display: none;
        align-items: center;
        justify-content: space-between;
        z-index: 10000;
        box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
        animation: slideUpReply 0.3s ease;
    }

    .reply-mode-overlay.active {
        display: flex;
    }

    .reply-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .reply-arrow {
        font-size: 16px;
    }

    .reply-text {
        font-weight: 600;
    }

    .reply-snippet {
        opacity: 0.8;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .reply-cancel {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        transition: background 0.2s ease;
    }

    .reply-cancel:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    @keyframes slideUpReply {
        from { transform: translateY(100%); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('chat-page');
});
</script>
{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø JS –ò–ó INTEGRATED + Telegram overlay --- #}
{% block extra_js %}
<script src="{% static 'js/auto_join_fix.js' %}"></script>
<script src="{% static 'js/telegram_chat_overlay.js' %}"></script>
<script>
let isSwitching=false;
function switchChannel(name){
 if(isSwitching)return;isSwitching=true;
 const frame=document.getElementById('rocketchat-iframe');
 const t=Date.now();
 frame.src=`{{ rocketchat_url }}/channel/${name}?layout=embedded&t=${t}`;
 frame.onload=()=>{
   isSwitching=false;
 };
}

window.addEventListener('load',()=>{
 const params=new URLSearchParams(window.location.search);
 const ch=params.get('channel');
 if(ch&&ch!=='general')switchChannel(ch);

 // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
 updateChannelNavTitle(ch || 'general');
});

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function switchChannelNav(channel) {
 switchChannel(channel);
 updateChannelNavTitle(channel);
 return false; // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function updateChannelNavTitle(channel) {
 const nameEl = document.getElementById('currentChannelName');
 const buttonEl = document.getElementById('channelDropdownNav');
 if (!nameEl || !buttonEl) return;

 const titles = {
   'general': '–û–±—â–∏–π',
   'vip': 'VIP',
   'moderators': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã'
 };

 // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ë–ï–ó —Å–∏–º–≤–æ–ª–∞ #
 nameEl.textContent = titles[channel] || '–û–±—â–∏–π';

 // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ - —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
 buttonEl.classList.remove('channel-general', 'channel-vip', 'channel-moderators');
 buttonEl.classList.add('channel-' + channel);
}

// –ü–†–û–°–¢–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–ù–û–ü–û–ö –ù–ê–í–ò–ì–ê–¶–ò–ò
function scrollToBottom() {
    const iframe = document.getElementById('rocketchat-iframe');
    if (iframe && iframe.contentWindow) {
        try {
            iframe.contentWindow.postMessage({type: 'scroll-to-bottom'}, 'http://127.0.0.1:3000');
        } catch(e) {
            console.log('–°–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é (demo)');
        }
    }
}

function scrollToFirstUnread() {
    const iframe = document.getElementById('rocketchat-iframe');
    if (iframe && iframe.contentWindow) {
        try {
            iframe.contentWindow.postMessage({type: 'scroll-to-first-unread'}, 'http://127.0.0.1:3000');
        } catch(e) {
            console.log('–°–∫—Ä–æ–ª–ª –∫ –ø–µ—Ä–≤–æ–º—É –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º—É (demo)');
        }
    }
}

// üéØ –û–ë–†–ê–ë–û–¢–ß–ò–ö TELEGRAM OVERLAY –°–û–ë–´–¢–ò–ô
window.addEventListener('message', (event) => {
    if (event.data.type === 'telegram-reply-mode') {
        showReplyModeOverlay(event.data);
    } else if (event.data.type === 'telegram-add-reaction') {
        addReactionToMessage(event.data);
    }
});

// üìù –ü–û–ö–ê–ó–ê–¢–¨ –†–ï–ñ–ò–ú –û–¢–í–ï–¢–ê –ö–ê–ö –í TELEGRAM
function showReplyModeOverlay(data) {
    const overlay = document.getElementById('reply-mode-overlay');
    const authorEl = overlay.querySelector('.reply-author');
    const snippetEl = overlay.querySelector('.reply-snippet');

    authorEl.textContent = data.messageAuthor || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
    snippetEl.textContent = data.messageText.substring(0, 50) + (data.messageText.length > 50 ? '...' : '');

    overlay.classList.add('active');

    console.log('üìù –†–µ–∂–∏–º –æ—Ç–≤–µ—Ç–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω:', data);
}

// ‚ùå –û–¢–ú–ï–ù–ê –†–ï–ñ–ò–ú–ê –û–¢–í–ï–¢–ê
function cancelReplyMode() {
    const overlay = document.getElementById('reply-mode-overlay');
    overlay.classList.remove('active');
}

// üëç –î–û–ë–ê–í–ò–¢–¨ –†–ï–ê–ö–¶–ò–Æ –ö –°–û–û–ë–©–ï–ù–ò–Æ
function addReactionToMessage(data) {
    console.log('üëç –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∞–∫—Ü–∏–∏:', data.emoji, '–∫ —Å–æ–æ–±—â–µ–Ω–∏—é:', data.messageId);

    // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Rocket.Chat API
    // –ü–æ–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if (window.showNotification) {
        window.showNotification(`–†–µ–∞–∫—Ü–∏—è ${data.emoji} –¥–æ–±–∞–≤–ª–µ–Ω–∞!`, 'success');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞
document.addEventListener('click', function(event) {
 const dropdown = document.getElementById('channelDropdownNav');
 const dropdownMenu = dropdown ? dropdown.nextElementSibling : null;

 // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ dropdown –∏ –Ω–µ –ø–æ –µ–≥–æ –º–µ–Ω—é - –∑–∞–∫—Ä—ã–≤–∞–µ–º
 if (dropdown && dropdownMenu &&
     !dropdown.contains(event.target) &&
     !dropdownMenu.contains(event.target)) {

   // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown —á–µ—Ä–µ–∑ Bootstrap API
   const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
   if (bsDropdown) {
     bsDropdown.hide();
   }
 }
});

// –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
document.addEventListener('keydown', function(event) {
 if (event.key === 'Escape') {
   const dropdown = document.getElementById('channelDropdownNav');
   if (dropdown) {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) {
       bsDropdown.hide();
     }
   }
 }
});
</script>
{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê –ò–ó INTEGRATED + Reply overlay --- #}
{% block main_container %}
    <div class="chat-container">
        <iframe id="rocketchat-iframe" src="{{ rocketchat_url }}/channel/general?layout=embedded" allow="camera; microphone; clipboard-write"></iframe>

        <!-- üìù –†–ï–ñ–ò–ú –û–¢–í–ï–¢–ê –ö–ê–ö –í TELEGRAM -->
        <div id="reply-mode-overlay" class="reply-mode-overlay">
            <div class="reply-info">
                <span class="reply-arrow">‚Ü©Ô∏è</span>
                <span class="reply-text">–í –æ—Ç–≤–µ—Ç <strong class="reply-author">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</strong></span>
                <span class="reply-snippet">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...</span>
            </div>
            <button class="reply-cancel" onclick="cancelReplyMode()">‚úï</button>
        </div>

        <!-- –ú–ê–õ–ï–ù–¨–ö–ò–ô –¢–ï–°–¢–û–í–´–ô –ò–ù–î–ò–ö–ê–¢–û–† -->
        <div class="test-indicator">
            üß™ Telegram Hover v1.0
        </div>
    </div>
{% endblock %}

{# --- –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ—É—Ç–µ—Ä --- #}
{% block footer %}{% endblock %}
