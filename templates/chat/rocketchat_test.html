{% extends 'base.html' %}
{% load static %}

{% comment %}
üß™ –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê Rocket.Chat - –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø INTEGRATED + –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 25 –∏—é–Ω—è 2025 –≥.
–°—Ç–∞—Ç—É—Å: –ò–°–ü–†–ê–í–õ–ï–ù–ê - —É–±—Ä–∞–Ω–∞ –ª–∏—à–Ω—è—è –ø–ª–∞—à–∫–∞, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ SSOT —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
{% endcomment %}

{% block title %}üß™ –ß–∞—Ç (—Ç–µ—Å—Ç) - –ë–µ—Å–µ–¥–∫–∞{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –°–¢–ò–õ–ï–ô –ò–ó INTEGRATED + —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ --- #}
{% block extra_css %}
<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è body —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∞—Ç–∞ - –ö–û–ü–ò–Ø –ò–ó integrated */
    body.chat-page {
        overflow-y: hidden; /* –í—Å—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤ html, nav –Ω–µ —Å–º–µ—â–∞–µ—Ç—Å—è */
    }

    .chat-container {
        position: fixed;
        top: 60px;   /* –≤—ã—Å–æ—Ç–∞ navbar - –ö–ê–ö –í –û–†–ò–ì–ò–ù–ê–õ–ï */
        left: 0;
        right: 0;
        bottom: 0;
        background: #1a1a2e;
        display: flex;
        flex-direction: column;
    }

    .chat-container iframe {
        flex: 1;
        width: 100%;
        border: none;
    }

    /* === –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –ö–ù–û–ü–ö–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ß–ê–¢–û–ú (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã) === */
    .chat-control-enlarged {
        position: relative;
        padding: 0.75rem 1rem !important; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .chat-control-enlarged:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: scale(1.05);
    }

    .nav-icon-enlarged {
        font-size: 1.5rem !important; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ */
        color: #ffffff;
    }

    .nav-counter-badge-enlarged {
        position: absolute;
        top: 8px;
        right: 8px;
        min-width: 22px;
        height: 22px;
        font-size: 11px !important;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #343a40;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ */
    .nav-link-with-counter {
        position: relative;
        min-width: 60px; /* –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è badge */
    }

    /* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫: —Å—á–µ—Ç—á–∏–∫ –æ—Ç–¥–∞–ª–µ–Ω, —Å—Ç—Ä–µ–ª–∫–∏ –±–ª–∏–∑–∫–æ –¥—Ä—É–≥ –∫ –¥—Ä—É–≥—É */
    .chat-control-enlarged + .chat-control-enlarged {
        margin-left: -0.5rem; /* –°–±–ª–∏–∂–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –º–µ–∂–¥—É —Å–æ–±–æ–π */
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('chat-page');
});
</script>
{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø JS –ò–ó INTEGRATED + –¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è --- #}
{% block extra_js %}
<script src="{% static 'js/auto_join_fix.js' %}"></script>
<script>
// === –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –ò–ó INTEGRATED ===
let isSwitching=false;
function switchChannel(name){
 if(isSwitching)return;isSwitching=true;
 const frame=document.getElementById('rocketChatFrame');
 const t=Date.now();
 frame.src=`{{ rocketchat_url }}/channel/${name}?layout=embedded&t=${t}`;
 frame.onload=()=>{
   isSwitching=false;
 };
}

window.addEventListener('load',()=>{
 const params=new URLSearchParams(window.location.search);
 const ch=params.get('channel');
 if(ch&&ch!=='general')switchChannel(ch);

 // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
 updateChannelNavTitle(ch || 'general');
});

// –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function switchChannelNav(channel) {
 switchChannel(channel);
 updateChannelNavTitle(channel);
 return false; // –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
function updateChannelNavTitle(channel) {
 const nameEl = document.getElementById('currentChannelName');
 const buttonEl = document.getElementById('channelDropdownNav');
 if (!nameEl || !buttonEl) return;

 const titles = {
   'general': '–û–±—â–∏–π',
   'vip': 'VIP',
   'moderators': '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä—ã'
 };

 // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ë–ï–ó —Å–∏–º–≤–æ–ª–∞ #
 nameEl.textContent = titles[channel] || '–û–±—â–∏–π';

 // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ - —É–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π
 buttonEl.classList.remove('channel-general', 'channel-vip', 'channel-moderators');
 buttonEl.classList.add('channel-' + channel);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–µ –º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞ (—É—Å–∏–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
document.addEventListener('click', function(event) {
 const dropdown = document.getElementById('channelDropdownNav');
 const dropdownMenu = dropdown ? dropdown.nextElementSibling : null;

 // –ï—Å–ª–∏ –∫–ª–∏–∫ –Ω–µ –ø–æ dropdown –∏ –Ω–µ –ø–æ –µ–≥–æ –º–µ–Ω—é - –∑–∞–∫—Ä—ã–≤–∞–µ–º
 if (dropdown && dropdownMenu &&
     !dropdown.contains(event.target) &&
     !dropdownMenu.contains(event.target)) {

   // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown —á–µ—Ä–µ–∑ Bootstrap API
   const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
   if (bsDropdown) {
     bsDropdown.hide();
   }
 }
});

// –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø–æ –∫–ª–∞–≤–∏—à–µ Escape
document.addEventListener('keydown', function(event) {
 if (event.key === 'Escape') {
   const dropdown = document.getElementById('channelDropdownNav');
   if (dropdown) {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) {
       bsDropdown.hide();
     }
   }
 }
});

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞ –∏–ª–∏ –∫–ª–∏–∫–µ –Ω–∞ iframe
document.addEventListener('DOMContentLoaded', function() {
 const dropdown = document.getElementById('channelDropdownNav');
 const iframe = document.getElementById('rocketChatFrame');

 if (dropdown && iframe) {
   // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ iframe
   iframe.addEventListener('mousedown', function() {
     const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
     if (bsDropdown) {
       bsDropdown.hide();
     }
   });

   // –ó–∞–∫—Ä—ã–≤–∞–µ–º dropdown –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
   dropdown.addEventListener('blur', function() {
     setTimeout(function() {
       const bsDropdown = bootstrap.Dropdown.getInstance(dropdown);
       if (bsDropdown) {
         bsDropdown.hide();
       }
     }, 150);
   });
 }
});

// === –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ù–û–í–´–• –ö–ù–û–ü–û–ö ===

// ‚¨áÔ∏è‚¨ÜÔ∏è –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–æ–æ–±—â–µ–Ω–∏—è–º
function scrollToBottom() {
    const frame = document.getElementById('rocketChatFrame');
    if (frame && frame.contentWindow) {
        try {
            // –ü—ã—Ç–∞–µ–º—Å—è —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–∫—Ä–æ–ª–ª–æ–º –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ iframe
            frame.contentWindow.postMessage({
                action: 'scrollToBottom',
                source: 'besedka-test'
            }, '*');

            // –¢–∞–∫–∂–µ –ø—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å–∞–º iframe –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ postMessage –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
            frame.contentWindow.scrollTo(0, frame.contentWindow.document.body.scrollHeight);
        } catch (e) {
            // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ postMessage, –ø—ã—Ç–∞–µ–º—Å—è —Å–∫—Ä–æ–ª–ª–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä iframe
            console.log('üöÄ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é');
            frame.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }
    }
    console.log('üöÄ –°–∫—Ä–æ–ª–ª –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é');
}

function scrollToFirstUnread() {
    const frame = document.getElementById('rocketChatFrame');
    if (frame && frame.contentWindow) {
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –≤ Rocket.Chat
            frame.contentWindow.postMessage({
                action: 'scrollToFirstUnread',
                source: 'besedka-test'
            }, '*');

            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ - —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–∞—á–∞–ª—É –∫–∞–∫ –∫ "–ø–µ—Ä–≤–æ–º—É –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º—É"
            frame.contentWindow.scrollTo(0, 0);
        } catch (e) {
            console.log('üöÄ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫ –ø–µ—Ä–≤–æ–º—É –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º—É');
            frame.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    console.log('üöÄ –°–∫—Ä–æ–ª–ª –∫ –ø–µ—Ä–≤–æ–º—É –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–º—É');
}

// –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Rocket.Chat iframe
window.addEventListener('message', function(event) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—à–µ–≥–æ Rocket.Chat
    if (event.origin === 'http://127.0.0.1:3000') {
        console.log('üöÄ –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Rocket.Chat:', event.data);

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        if (event.data && event.data.type === 'unread-count') {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö
            const badge = document.getElementById('unreadBadge');
            if (badge && event.data.count > 0) {
                badge.textContent = event.data.count > 99 ? '99+' : event.data.count;
                badge.style.display = 'flex';
            } else if (badge) {
                badge.style.display = 'none';
            }
        }
    }
});

// üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞–º–∏ (—Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
setTimeout(() => {
    {% if enable_message_counters %}
    const badge = document.getElementById('unreadBadge');
    if (badge) {
        badge.textContent = '3';
        badge.style.display = 'flex';
    }
    {% endif %}
}, 1000);
</script>
{% endblock %}

{# --- –¢–û–ß–ù–ê–Ø –ö–û–ü–ò–Ø –ö–û–ù–¢–ï–ô–ù–ï–†–ê –ò–ó INTEGRATED --- #}
{% block main_container %}
    <div class="chat-container">
        <iframe id="rocketChatFrame" src="{{ rocketchat_url }}/channel/general?layout=embedded" allow="camera; microphone; clipboard-write"></iframe>
    </div>
{% endblock %}

{# --- –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ—É—Ç–µ—Ä --- #}
{% block footer %}{% endblock %}
