<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket.Chat Test - –ë–µ—Å–µ–¥–∫–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f8f9fa;
            padding-top: 180px; /* –£–≤–µ–ª–∏—á–µ–Ω–æ –º–µ—Å—Ç–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ */
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –ë–µ—Å–µ–¥–∫–∏ */
        .navbar {
            position: fixed;
            top: 0;
            z-index: 1040;
        }

        .test-header {
            background: linear-gradient(135deg, #ff6b6b, #e74c3c);
            color: white;
            padding: 10px 20px;
            font-size: 14px;
            text-align: center;
            position: fixed;
            top: 56px; /* –ü–æ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π */
            left: 0;
            right: 0;
            z-index: 1030;
            border-bottom: 2px solid #c0392b;
        }

        .test-info {
            font-size: 11px;
            opacity: 0.9;
            margin-top: 3px;
        }

        /* –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å */
        .diagnostic-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            position: fixed;
            top: 110px;
            left: 0;
            right: 0;
            z-index: 1020;
            font-size: 13px;
        }

        .diagnostic-panel .btn {
            font-size: 12px;
            padding: 4px 12px;
            margin: 2px;
        }

        .iframe-container {
            width: 100%;
            height: calc(100vh - 180px);
            position: relative;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0 10px;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #666;
            font-size: 16px;
            text-align: center;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            display: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .test-nav-active {
            background-color: rgba(255, 107, 107, 0.1) !important;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è –ë–µ—Å–µ–¥–∫–∏ (–ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid px-4">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-home"></i> –ë–µ—Å–µ–¥–∫–∞
            </a>
            <button class="navbar-toggler" type="button">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse show">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-newspaper"></i> –ù–æ–≤–æ—Å—Ç–∏
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-store"></i> –ú–∞–≥–∞–∑–∏–Ω
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-seedling"></i> –ì—Ä–æ—É—Ä–µ–ø–æ—Ä—Ç—ã
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">
                            <i class="fas fa-images"></i> –ì–∞–ª–µ—Ä–µ—è
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link test-nav-active" href="#">
                            <i class="fas fa-comments"></i> –ß–∞—Ç (–¢–ï–°–¢)
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'chat:general' %}">
                            <i class="fas fa-arrow-left"></i> –û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="test-header">
        üöÄ –¢–ï–°–¢–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –ú–ò–ì–†–ê–¶–ò–ò - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Rocket.Chat –≤ –ø—Ä–æ–µ–∫—Ç "–ë–µ—Å–µ–¥–∫–∞"
        <div class="test-info">
            –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ä–µ–¥–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è | URL: {{ rocketchat_url }}
        </div>
    </div>

    <!-- –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="diagnostic-panel">
        <strong>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Rocket.Chat:</strong>
        <span id="status">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...</span>
        <div class="mt-2">
            <button class="btn btn-primary btn-sm" onclick="testConnection()">
                <i class="fas fa-refresh"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            </button>
            <button class="btn btn-warning btn-sm" onclick="openDirect()">
                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –Ω–∞–ø—Ä—è–º—É—é
            </button>
            <button class="btn btn-info btn-sm" onclick="reloadIframe()">
                <i class="fas fa-sync"></i> –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            </button>
        </div>
    </div>

    <div class="iframe-container">
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ Rocket.Chat...<br>
            <small>–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è, –≤–æ–∑–º–æ–∂–Ω–æ iframe –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</small>
        </div>
        <iframe
            id="rocketframe"
            src="{{ rocketchat_url }}"
            allow="camera; microphone; clipboard-write; fullscreen"
            allowfullscreen
            onload="handleIframeLoad()"
            onerror="handleIframeError()">
        </iframe>
    </div>

    <div class="error-message" id="error-message">
        <h5><i class="fas fa-exclamation-triangle"></i> –ü—Ä–æ–±–ª–µ–º–∞ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π</h5>
        <p>Rocket.Chat –Ω–µ –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –≤ iframe. –≠—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∏–∑-–∑–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ X-Frame-Options.</p>
        <p><strong>–†–µ—à–µ–Ω–∏–µ:</strong> –ó–∞–π–¥–∏—Ç–µ –≤ <a href="{{ rocketchat_url }}" target="_blank">Rocket.Chat –Ω–∞–ø—Ä—è–º—É—é</a> –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ iframe –≤ Administration ‚Üí Settings ‚Üí General.</p>
    </div>

    <script>
        let connectionStatus = 'unknown';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Rocket.Chat
        async function testConnection() {
            const statusEl = document.getElementById('status');
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';

            try {
                const response = await fetch('{{ rocketchat_url }}', {
                    method: 'HEAD',
                    mode: 'no-cors'
                });
                statusEl.innerHTML = '<span style="color: green;"><i class="fas fa-check"></i> Rocket.Chat –¥–æ—Å—Ç—É–ø–µ–Ω</span>';
                connectionStatus = 'available';
            } catch (error) {
                statusEl.innerHTML = '<span style="color: red;"><i class="fas fa-times"></i> –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>';
                connectionStatus = 'error';
            }
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
        function openDirect() {
            window.open('{{ rocketchat_url }}', '_blank');
        }

        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ iframe
        function reloadIframe() {
            const iframe = document.getElementById('rocketframe');
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            iframe.src = iframe.src;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ iframe
        function handleIframeLoad() {
            console.log('üöÄ Iframe loaded successfully');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('status').innerHTML = '<span style="color: green;"><i class="fas fa-check"></i> Iframe –∑–∞–≥—Ä—É–∂–µ–Ω</span>';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ iframe
        function handleIframeError() {
            console.log('‚ùå Iframe failed to load');
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('status').innerHTML = '<span style="color: red;"><i class="fas fa-times"></i> –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ iframe</span>';
        }

        // –¢–∞–π–º–µ—Ä –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
        setTimeout(() => {
            const loading = document.getElementById('loading');
            if (loading.style.display !== 'none') {
                handleIframeError();
            }
        }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', function() {
            console.log('üöÄ Rocket.Chat Test Page loaded with Besedka Navigation');
            console.log('Target URL:', '{{ rocketchat_url }}');
            testConnection();
        });

        // –£–±–∏—Ä–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏–∑ —Å—Å—ã–ª–æ–∫ –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏
        document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
            if (!link.href.includes('chat:general')) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('Navigation disabled in test mode');
                });
            }
        });
    </script>
</body>
</html>
