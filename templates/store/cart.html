{% extends "base.html" %}
{% load i18n static %}

{% block title %}{% translate "–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞" %} - Magic Beans{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'news:home' %}">{% translate "–ì–ª–∞–≤–Ω–∞—è" %}</a></li>
            <li class="breadcrumb-item"><a href="{% url 'store:catalog' %}">{% translate "–ö–∞—Ç–∞–ª–æ–≥" %}</a></li>
            <li class="breadcrumb-item active" aria-current="page">{% translate "–ö–æ—Ä–∑–∏–Ω–∞" %}</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0">{% translate "–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞" %}</h1>
        {% if cart_items %}
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-outline-danger btn-sm" id="clear-selected-btn" style="display: none;">
                <i class="fas fa-trash"></i> {% translate "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" %}
            </button>
            <button type="button" class="btn btn-danger btn-sm" id="clear-all-btn">
                <i class="fas fa-trash-alt"></i> {% translate "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É" %}
            </button>
        </div>
        {% endif %}
    </div>

    <!-- –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò –ö–û–†–ó–ò–ù–´ -->
    {% include 'includes/partials/_unified_cart_wrapper.html' with unified_card_list=unified_card_list %}

    {% if cart_items %}
    <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
    <div class="cart-summary mt-4">
        <div class="row">
            <div class="col-md-8">
                <!-- –í—ã–±–æ—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ -->
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-danger btn-sm" id="clear-selected-btn" style="display: none;">
                        <i class="fas fa-trash"></i> {% translate "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" %}
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" id="clear-all-btn">
                        <i class="fas fa-trash-alt"></i> {% translate "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É" %}
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞ -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">{% translate "–ò—Ç–æ–≥–æ" %}</h5>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span class="fs-4 fw-bold">{% translate "–ö –æ–ø–ª–∞—Ç–µ:" %}</span>
                            <span class="fs-4 fw-bold text-success" id="cart-total-amount">{{ cart.get_total_amount }} {% translate "—Ä—É–±." %}</span>
                        </div>
                        <div class="d-grid gap-2">
                            <a href="{% url 'store:checkout' %}" class="btn btn-success btn-lg">
                                {% translate "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" %} <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                            <a href="{% url 'store:catalog' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>{% translate "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∫—É–ø–∫–∏" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ CSRF —Ç–æ–∫–µ–Ω–∞
    let csrfToken = null;

    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    const csrfMeta = document.querySelector('meta[name=csrf-token]');

    if (csrfInput) {
        csrfToken = csrfInput.value;
    } else if (csrfMeta) {
        csrfToken = csrfMeta.getAttribute('content');
    } else {
        csrfToken = '{{ csrf_token }}';
    }

    if (!csrfToken) {
        console.error('‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    console.log('‚úÖ CSRF —Ç–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω:', csrfToken.substring(0, 10) + '...');

    // –ï–î–ò–ù–´–ô –ú–ï–ù–ï–î–ñ–ï–† –ö–û–†–ó–ò–ù–´
    class CartManager {
        constructor() {
            this.isUpdating = false;
            this.updateQueue = [];
            this.init();
        }

        init() {
            this.bindEvents();
            this.updateCheckboxStates();
        }

        // –ü–æ–∫–∞–∑ –∫—Ä–∞—Å–∏–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        showNotification(message, type = 'success') {
            if (window.showNotification) {
                window.showNotification(message, type);
            } else {
                console.log(`[${type}] ${message}`);
            }
        }

        // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–ë–ï–ó –°–ú–ï–©–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê)
        showLoadingIndicator(itemId, show = true) {
            const row = document.getElementById(`cart-item-${itemId}`);
            if (!row) return;

            const indicator = row.querySelector('.loading-indicator');
            const quantityGroup = row.querySelector('.quantity-input-group');

            if (indicator && quantityGroup) {
                if (show) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ü–û–í–ï–†–• —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–µ —Å–º–µ—â–∞—è –∏—Ö
                    indicator.style.display = 'block';
                    indicator.style.position = 'absolute';
                    indicator.style.top = '50%';
                    indicator.style.left = '50%';
                    indicator.style.transform = 'translate(-50%, -50%)';
                    indicator.style.zIndex = '10';
                    indicator.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
                    indicator.style.padding = '2px 8px';
                    indicator.style.borderRadius = '4px';
                    indicator.style.border = '1px solid #dee2e6';

                    // –î–µ–ª–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    quantityGroup.style.position = 'relative';
                    quantityGroup.style.opacity = '0.6';
                } else {
                    indicator.style.display = 'none';
                    quantityGroup.style.position = '';
                    quantityGroup.style.opacity = '1';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–∞
        async updateCartItem(itemId, quantity) {
            if (this.isUpdating) {
                this.updateQueue.push({ itemId, quantity });
                return;
            }

            this.isUpdating = true;
            this.showLoadingIndicator(itemId, true);

            try {
                const response = await fetch('{% url "store:update_cart" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `cart_item_id=${itemId}&quantity=${quantity}`
                });

                const data = await response.json();

                if (data.success) {
                    if (data.item_removed || quantity <= 0) {
                        // –¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω
                        this.removeItemFromDOM(itemId);
                        if (data.cart_total_items === 0) {
                            setTimeout(() => location.reload(), 500);
                            return;
                        }
                    } else {
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä–∞
                        this.updateItemInDOM(itemId, data);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
                    this.updateCartTotal(data.cart_total_amount);
                    this.updateCheckboxStates();

                    // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú –°–ß–ï–¢–ß–ò–ö –í –®–ê–ü–ö–ï
                    if (window.CartCounter) {
                        window.CartCounter.update(data.cart_total_items);
                    }

                    this.showNotification('{% translate "–ö–æ—Ä–∑–∏–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞" %}', 'success');
                } else {
                    this.showNotification(data.message || '{% translate "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã" %}', 'error');
                    this.revertQuantityInput(itemId, data.current_quantity);
                }
            } catch (error) {
                console.error('Error updating cart:', error);
                this.showNotification('{% translate "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞" %}', 'error');
            } finally {
                this.showLoadingIndicator(itemId, false);
                this.isUpdating = false;

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ –µ—Å—Ç—å –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã
                setTimeout(() => this.processQueue(), 100);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ —Å –∫—Ä–∞—Å–∏–≤—ã–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
        async removeCartItem(itemId) {
            if (this.isUpdating) {
                this.updateQueue.push({ itemId, quantity: 0 });
                return;
            }

            this.isUpdating = true;
            this.showLoadingIndicator(itemId, true);

            try {
                const response = await fetch('{% url "store:remove_from_cart" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `cart_item_id=${itemId}`
                });

                const data = await response.json();

                if (data.success) {
                    this.removeItemFromDOM(itemId);
                    this.updateCartTotal(data.cart_total_amount);

                    // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú –°–ß–ï–¢–ß–ò–ö –í –®–ê–ü–ö–ï
                    if (window.CartCounter) {
                        window.CartCounter.update(data.cart_total_items);
                    }

                    if (data.cart_total_items === 0) {
                        setTimeout(() => location.reload(), 500);
                    }

                    this.showNotification('{% translate "–¢–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã" %}', 'success');
                } else {
                    this.showNotification(data.message || '{% translate "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞" %}', 'error');
                }
            } catch (error) {
                console.error('Error removing from cart:', error);
                this.showNotification('{% translate "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞" %}', 'error');
            } finally {
                this.showLoadingIndicator(itemId, false);
                this.isUpdating = false;
                setTimeout(() => this.processQueue(), 100);
            }
        }

        // –ö—Ä–∞—Å–∏–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
        showConfirmDialog(title, message, confirmText, cancelText) {
            return new Promise((resolve) => {
                // –°–æ–∑–¥–∞–µ–º overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    animation: fadeIn 0.2s ease-out;
                `;

                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = document.createElement('div');
                modal.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    animation: scaleIn 0.2s ease-out;
                    text-align: center;
                `;

                modal.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #ff6b6b; margin-bottom: 15px;"></i>
                        <h4 style="margin: 0 0 10px 0; color: #333;">${title}</h4>
                        <p style="margin: 0; color: #666; line-height: 1.5;">${message}</p>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="confirm-btn" style="
                            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s ease;
                        ">${confirmText}</button>
                        <button id="cancel-btn" style="
                            background: #f8f9fa;
                            color: #6c757d;
                            border: 1px solid #dee2e6;
                            padding: 12px 24px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                            transition: all 0.2s ease;
                        ">${cancelText}</button>
                    </div>
                `;

                overlay.appendChild(modal);
                document.body.appendChild(overlay);

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                const confirmBtn = modal.querySelector('#confirm-btn');
                const cancelBtn = modal.querySelector('#cancel-btn');

                const cleanup = () => {
                    overlay.style.animation = 'fadeOut 0.2s ease-in';
                    setTimeout(() => overlay.remove(), 200);
                };

                confirmBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(true);
                });

                cancelBtn.addEventListener('click', () => {
                    cleanup();
                    resolve(false);
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ overlay
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        cleanup();
                        resolve(false);
                    }
                });

                // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        cleanup();
                        resolve(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ DOM
        updateItemInDOM(itemId, data) {
            const input = document.querySelector(`input[data-item-id="${itemId}"]`);
            if (input && data.quantity !== undefined) {
                input.value = data.quantity;
            }

            const itemTotalElement = document.getElementById(`item-total-${itemId}`);
            if (itemTotalElement && data.item_total_price !== undefined) {
                itemTotalElement.textContent = `${data.item_total_price} {% translate "—Ä—É–±." %}`;
            }

            const row = document.getElementById(`cart-item-${itemId}`);
            const availableElement = row ? row.querySelector('.available-quantity') : null;

            // –ü—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ (–æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏)
            if (availableElement && data.updated_stock_quantity !== undefined) {
                availableElement.textContent = `{% translate "–î–æ—Å—Ç—É–ø–Ω–æ:" %} ${data.updated_stock_quantity}`;
                console.log(`–û–±–Ω–æ–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${itemId}: –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ=${data.updated_stock_quantity}`);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç—ã –ø–æ–ª—è –≤–≤–æ–¥–∞
            if (input && data.updated_stock_quantity !== undefined && data.quantity !== undefined) {
                const totalAvailable = data.updated_stock_quantity + data.quantity;
                input.setAttribute('max', totalAvailable);
                input.setAttribute('data-max-total', totalAvailable);
                input.setAttribute('data-current-stock', data.updated_stock_quantity);
                console.log(`–û–±–Ω–æ–≤–ª–µ–Ω—ã –∞—Ç—Ä–∏–±—É—Ç—ã –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${itemId}: max=${totalAvailable}`);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ DOM
        removeItemFromDOM(itemId) {
            const itemRow = document.getElementById(`cart-item-${itemId}`);
            if (itemRow) {
                itemRow.classList.add('removing-item');
                setTimeout(() => {
                    itemRow.remove();
                    this.updateCheckboxStates();
                }, 300);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—â–µ–π —Å—É–º–º—ã
        updateCartTotal(amount) {
            const cartTotalElement = document.getElementById('cart-total-amount');
            if (cartTotalElement) {
                cartTotalElement.textContent = `${amount} {% translate "—Ä—É–±." %}`;
            }
        }

        // –í–æ–∑–≤—Ä–∞—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        revertQuantityInput(itemId, quantity) {
            const input = document.querySelector(`input[data-item-id="${itemId}"]`);
            if (input && quantity !== undefined) {
                input.value = quantity;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
        processQueue() {
            if (this.updateQueue.length > 0) {
                const { itemId, quantity } = this.updateQueue.shift();
                this.updateCartItem(itemId, quantity);
            }
        }

        // –ú–ì–ù–û–í–ï–ù–ù–û–ï –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è "–î–æ—Å—Ç—É–ø–Ω–æ" (–¥–æ AJAX)
        updateAvailableQuantityInstantly(itemId, oldQuantity, newQuantity) {
            console.log(`üîç –ù–ê–ß–ê–õ–û updateAvailableQuantityInstantly: —Ç–æ–≤–∞—Ä ${itemId}, ${oldQuantity} -> ${newQuantity}`);

            const row = document.getElementById(`cart-item-${itemId}`);
            const availableElement = row ? row.querySelector('.available-quantity') : null;
            const input = document.querySelector(`input[data-item-id="${itemId}"]`);

            console.log(`–û—Ç–ª–∞–¥–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: row=${!!row}, availableElement=${!!availableElement}, input=${!!input}`);

            if (availableElement && input) {
                console.log(`–¢–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –ø–æ–ª—è "–î–æ—Å—Ç—É–ø–Ω–æ": "${availableElement.textContent}"`);

                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ (–ë–ï–ó —É—á–µ—Ç–∞ –∫–æ—Ä–∑–∏–Ω—ã)
                const currentStock = parseInt(input.getAttribute('data-current-stock')) || 0;
                console.log(`–¢–µ–∫—É—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ: ${currentStock}`);

                // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:
                // –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ - —É–º–µ–Ω—å—à–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
                // –ü—Ä–∏ —É–º–µ–Ω—å—à–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ
                const quantityDiff = newQuantity - oldQuantity;
                const newAvailableDisplay = currentStock - quantityDiff;

                console.log(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ: ${quantityDiff}`);
                console.log(`–ù–æ–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${currentStock} - ${quantityDiff} = ${newAvailableDisplay}`);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ–ª—è "–î–æ—Å—Ç—É–ø–Ω–æ"
                const oldText = availableElement.textContent.trim();
                const newText = `{% translate "–î–æ—Å—Ç—É–ø–Ω–æ:" %} ${Math.max(0, newAvailableDisplay)}`;
                availableElement.textContent = newText;
                console.log(`üìù –û–±–Ω–æ–≤–∏–ª–∏ —Ç–µ–∫—Å—Ç —Å "${oldText}" –Ω–∞ "${newText}"`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
                // –ú–∞–∫—Å–∏–º—É–º = –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–∫–ª–∞–¥–µ + –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                const maxAvailable = Math.max(0, newAvailableDisplay) + newQuantity;
                input.setAttribute('max', Math.max(1, maxAvailable));
                input.setAttribute('data-max-total', Math.max(1, maxAvailable));
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
                input.setAttribute('data-current-stock', Math.max(0, newAvailableDisplay));

                console.log(`‚úÖ –£–°–ü–ï–•: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${itemId} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);
                console.log(`   –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ: ${oldQuantity} -> ${newQuantity}`);
                console.log(`   –û—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π –æ—Å—Ç–∞—Ç–æ–∫: ${Math.max(0, newAvailableDisplay)}, –º–∞–∫—Å. –¥–ª—è –∑–∞–∫–∞–∑–∞: ${Math.max(1, maxAvailable)}`);
            }
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π
        bindEvents() {
            const self = this; // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ this

            // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            window.cartManagerInstance = this;

            // –ö–Ω–æ–ø–∫–∏ +/-
            document.querySelectorAll('.quantity-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const action = button.dataset.action;
                    const itemId = button.dataset.itemId;
                    const input = document.querySelector(`input.quantity-input[data-item-id="${itemId}"]`);

                    if (input) {
                        let currentValue = parseInt(input.value) || 1;
                        let newValue = currentValue;
                        const maxTotal = parseInt(input.getAttribute('data-max-total')) || parseInt(input.getAttribute('max')) || 0;
                        const currentStock = parseInt(input.getAttribute('data-current-stock')) || 0;

                        if (action === 'increase') {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ª–∏ –æ–±—â–∏–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫
                            if (maxTotal > 0 && currentValue < maxTotal) {
                                newValue = currentValue + 1;
                            } else {
                                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–µ —Ç–æ–≤–∞—Ä–∞
                                self.showNotification(`{% translate "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞. –ú–∞–∫—Å–∏–º—É–º:" %} ${maxTotal}`, 'error');
                                return; // –ù–µ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
                            }
                        } else if (action === 'decrease') {
                            if (currentValue > 1) {
                                newValue = currentValue - 1;
                            } else {
                                return; // –ù–µ –º–æ–∂–µ–º —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∏–∂–µ 1
                            }
                        }

                        if (newValue !== currentValue) {
                            input.value = newValue;

                            // –ú–ì–ù–û–í–ï–ù–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ "–î–æ—Å—Ç—É–ø–Ω–æ" –¥–æ AJAX-–∑–∞–ø—Ä–æ—Å–∞
                            console.log(`–í—ã–∑—ã–≤–∞–µ–º updateAvailableQuantityInstantly –¥–ª—è —Ç–æ–≤–∞—Ä–∞ ${itemId}: ${currentValue} -> ${newValue}`);
                            try {
                                self.updateAvailableQuantityInstantly(itemId, currentValue, newValue);
                            } catch (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', error);
                            }

                            self.updateCartItem(itemId, newValue);
                        }
                    }
                });
            });

            // –ü—Ä—è–º–æ–π –≤–≤–æ–¥ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
            document.querySelectorAll('.quantity-input').forEach(input => {
                let lastValue = input.value;

                const handleQuantityChange = () => {
                    const itemId = input.dataset.itemId;
                    const quantity = parseInt(input.value) || 1;
                    const maxTotal = parseInt(input.getAttribute('data-max-total')) || parseInt(input.getAttribute('max')) || 999;

                    const finalQuantity = Math.max(1, Math.min(quantity, maxTotal));

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –±–æ–ª—å—à–µ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ
                    if (quantity > maxTotal) {
                        self.showNotification(`{% translate "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:" %} ${maxTotal}`, 'warning');
                    }

                    // –í–°–ï–ì–î–ê –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –ø–æ–ª–µ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                    input.value = finalQuantity;

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
                    if (finalQuantity.toString() !== lastValue) {
                        lastValue = finalQuantity.toString();
                        self.updateCartItem(itemId, finalQuantity);
                    }
                };

                input.addEventListener('change', handleQuantityChange);
                input.addEventListener('blur', handleQuantityChange);

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                input.addEventListener('input', (e) => {
                    const quantity = parseInt(input.value) || 1;
                    const maxTotal = parseInt(input.getAttribute('data-max-total')) || parseInt(input.getAttribute('max')) || 999;

                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤–≤–æ–¥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
                    if (quantity > maxTotal) {
                        input.value = maxTotal;
                        self.showNotification(`{% translate "–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ:" %} ${maxTotal}`, 'warning');
                    }
                    if (quantity < 1) {
                        input.value = 1;
                    }
                });

                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–≤–æ–¥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    }
                });
            });

            // –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            document.querySelectorAll('.remove-from-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const itemId = button.dataset.itemId;
                    self.removeCartItem(itemId);
                });
            });

            // –ß–µ–∫–±–æ–∫—Å—ã
            self.bindCheckboxEvents();

            // –ö–Ω–æ–ø–∫–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
            self.bindMassActionEvents();
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–µ–∫–±–æ–∫—Å–æ–≤
        bindCheckboxEvents() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                    const itemCheckboxes = document.querySelectorAll('.item-checkbox');
                    itemCheckboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                    this.updateCheckboxStates();
                });
            }

            document.querySelectorAll('.item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    e.stopPropagation();
                    this.updateCheckboxStates();
                });

                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
            });
        }

        // –ü—Ä–∏–≤—è–∑–∫–∞ —Å–æ–±—ã—Ç–∏–π –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
        bindMassActionEvents() {
            const self = this;
            const clearSelectedBtn = document.getElementById('clear-selected-btn');
            if (clearSelectedBtn) {
                clearSelectedBtn.addEventListener('click', async () => {
                    const checkedBoxes = document.querySelectorAll('.item-checkbox:checked');
                    if (checkedBoxes.length === 0) return;

                    const confirmed = await self.showConfirmDialog(
                        '{% translate "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã?" %}',
                        `{% translate "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã" %} (${checkedBoxes.length})?`,
                        '{% translate "–£–¥–∞–ª–∏—Ç—å –≤—Å–µ" %}',
                        '{% translate "–û—Ç–º–µ–Ω–∞" %}'
                    );

                    if (!confirmed) return;

                    // –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ
                    let deletedCount = 0;
                    for (const checkbox of checkedBoxes) {
                        const itemId = checkbox.dataset.itemId;
                        const success = await self.removeCartItemSilent(itemId);
                        if (success) deletedCount++;
                    }

                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
                    if (deletedCount > 0) {
                        self.showNotification(`{% translate "–£–¥–∞–ª–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:" %} ${deletedCount}`, 'success');
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–æ—Å—å –ª–∏ —á—Ç–æ-—Ç–æ –≤ –∫–æ—Ä–∑–∏–Ω–µ
                    const remainingItems = document.querySelectorAll('.cart-item-row');
                    if (remainingItems.length === 0) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø—É—Å—Ç–æ–π –∫–æ—Ä–∑–∏–Ω–µ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        self.showNotification('{% translate "–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞" %}', 'success');
                        setTimeout(() => location.reload(), 1000);
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (window.CartCounter) {
                        const newTotalItems = remainingItems.length;
                        window.CartCounter.update(newTotalItems);
                    }
                });
            }

            const clearAllBtn = document.getElementById('clear-all-btn');
            if (clearAllBtn) {
                clearAllBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const confirmed = await self.showConfirmDialog(
                        '{% translate "–û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?" %}',
                        '‚ö†Ô∏è {% translate "–í–ù–ò–ú–ê–ù–ò–ï! –í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ü–û–õ–ù–û–°–¢–¨–Æ –û–ß–ò–°–¢–ò–¢–¨ –∫–æ—Ä–∑–∏–Ω—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}',
                        'üóëÔ∏è {% translate "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë" %}',
                        '{% translate "–û—Ç–º–µ–Ω–∞" %}'
                    );

                    if (!confirmed) return;

                    const allItems = document.querySelectorAll('.remove-from-cart-btn');
                    let deletedCount = 0;
                    for (const button of allItems) {
                        const itemId = button.dataset.itemId;
                        const success = await self.removeCartItemSilent(itemId);
                        if (success) deletedCount++;
                    }

                    if (deletedCount > 0) {
                        self.showNotification('{% translate "–ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω–∞" %}', 'success');
                    }
                    setTimeout(() => location.reload(), 1000);
                });
            }
        }

        // –¢–∏—Ö–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–±–µ–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è) - —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true/false –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —É—Å–ø–µ—Ö–∞
        async removeCartItemSilent(itemId) {
            try {
                const response = await fetch('{% url "store:remove_from_cart" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `cart_item_id=${itemId}`
                });

                const data = await response.json();

                if (data.success) {
                    this.removeItemFromDOM(itemId);
                    this.updateCartTotal(data.cart_total_amount);
                    this.updateCheckboxStates();

                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ
                    if (window.CartCounter) {
                        window.CartCounter.update(data.cart_total_items);
                    }

                    return true;
                } else {
                    console.error('Error removing item:', data.message);
                    return false;
                }
            } catch (error) {
                console.error('Error removing from cart:', error);
                return false;
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ–∫–±–æ–∫—Å–æ–≤
        updateCheckboxStates() {
            const itemCheckboxes = document.querySelectorAll('.item-checkbox');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const clearSelectedBtn = document.getElementById('clear-selected-btn');

            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            const totalCount = itemCheckboxes.length;

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = checkedCount === totalCount && totalCount > 0;
                selectAllCheckbox.indeterminate = checkedCount > 0 && checkedCount < totalCount;
            }

            if (clearSelectedBtn) {
                clearSelectedBtn.style.display = checkedCount > 0 ? 'inline-block' : 'none';
            }
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∫–æ—Ä–∑–∏–Ω—ã (–ì–õ–û–ë–ê–õ–¨–ù–û)
    window.cartManager = new CartManager();
    console.log('‚úÖ CartManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ');
});
</script>

<style>
/* –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ï –°–¢–ò–õ–ò –ö–û–†–ó–ò–ù–´ */

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –º–æ–¥–∞–ª–æ–∫ */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes scaleIn {
    from {
        transform: scale(0.8);
        opacity: 0;
    }
    to {
        transform: scale(1);
        opacity: 1;
    }
}

/* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ—Ä–∑–∏–Ω—ã - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏ –∫—Ä–∞—Å–∏–≤—ã–µ */
.cart-item-row {
    background-color: #ffffff !important;
    border: none !important;
    transition: none !important; /* –£–±–∏—Ä–∞–µ–º –≤—Å–µ hover —ç—Ñ—Ñ–µ–∫—Ç—ã */
    padding: 1rem 0.75rem !important;
}

/* –£–±–∏—Ä–∞–µ–º –≤—Å–µ hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Å—Ç—Ä–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */
.cart-item-row:hover {
    background-color: #ffffff !important; /* –û—Å—Ç–∞–µ—Ç—Å—è –±–µ–ª—ã–º */
    transform: none !important;
    box-shadow: none !important;
}

/* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫–æ—Ä–∑–∏–Ω—ã */
.table {
    border: 1px solid #e9ecef;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    background: #ffffff;
}

.table th {
    border-top: none !important;
    border-bottom: 2px solid #e9ecef !important;
    font-weight: 600;
    background-color: #f8f9fa !important;
    color: #495057 !important;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 1rem 0.75rem !important;
}

.table td {
    border-top: 1px solid #f1f3f4 !important;
    padding: 1rem 0.75rem !important;
    vertical-align: middle !important;
    color: #495057;
}

/* –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ (–∏—Ç–æ–≥–æ) */
.table tfoot tr {
    background-color: #f8f9fa !important;
    border-top: 2px solid #dee2e6 !important;
}

.table tfoot td {
    font-weight: 600 !important;
    color: #212529 !important;
    border-top: 2px solid #dee2e6 !important;
}

/* –ì—Ä—É–ø–ø–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º */
.quantity-control-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    position: relative;
}

.quantity-input-group {
    width: 140px;
    margin: 0 auto;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #dee2e6;
}

/* –ö–Ω–æ–ø–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
.quantity-btn {
    width: 40px;
    height: 40px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-weight: bold;
    font-size: 14px;
    border: none !important;
    background-color: #f8f9fa;
    transition: background-color 0.2s ease;
    user-select: none;
}

.quantity-btn:hover {
    background-color: #e9ecef;
}

.quantity-btn:active {
    background-color: #dee2e6;
}

.quantity-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
}

/* –ü–æ–ª–µ –≤–≤–æ–¥–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
.quantity-input {
    border: none !important;
    text-align: center;
    font-weight: bold;
    width: 60px;
    min-width: 60px;
    background-color: #ffffff;
    color: #495057;
    -moz-appearance: textfield;
    font-size: 0.95rem;
}

.quantity-input::-webkit-outer-spin-button,
.quantity-input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.quantity-input:focus {
    outline: none;
    box-shadow: none;
    background-color: #f8f9fa;
}

/* –ß–µ–∫–±–æ–∫—Å—ã */
.item-checkbox, #select-all-checkbox {
    transform: scale(1.3);
    cursor: pointer;
    accent-color: #0d6efd;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è */
.removing-item {
    opacity: 0.5;
    transform: scale(0.95);
    transition: all 0.3s ease;
}

/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
.loading-indicator {
    font-size: 12px;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    background-color: rgba(255, 255, 255, 0.95);
    padding: 4px 8px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: none;
}

/* –•–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏ */
.breadcrumb-item + .breadcrumb-item::before {
    content: "‚Ä∫";
    color: #6c757d;
    font-weight: bold;
}

.breadcrumb-item.active {
    color: #495057;
    font-weight: 500;
}

/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π - —É–ª—É—á—à–µ–Ω–Ω—ã–µ */
.remove-from-cart-btn {
    border: 1px solid #dc3545;
    color: #dc3545;
    background-color: transparent;
    transition: all 0.2s ease;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

.remove-from-cart-btn:hover {
    background-color: #dc3545;
    color: white;
    border-color: #dc3545;
}

/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ */
.cart-item-image {
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease;
}

.cart-item-image:hover {
    transform: scale(1.05);
}

/* –°—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã */
.cart-item-row a {
    text-decoration: none;
    color: #495057;
    transition: color 0.2s ease;
}

.cart-item-row a:hover {
    color: #0d6efd;
}

/* –î–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ */
.available-quantity {
    color: #6c757d !important;
    font-size: 0.8rem !important;
    margin-top: 0.25rem;
}

/* –¶–µ–Ω—ã –∏ —Å—É–º–º—ã */
.item-total-cell {
    font-weight: 600 !important;
    color: #198754 !important;
    font-size: 1rem;
}

/* –ö–Ω–æ–ø–∫–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */
.btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    border-color: #dc3545;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    border-color: #dc3545;
}

.btn-danger:hover {
    background-color: #c82333;
    border-color: #bd2130;
}

/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–æ—Ä–∑–∏–Ω—ã */
h1 {
    color: #212529;
    font-weight: 600;
}

/* –ö–Ω–æ–ø–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å/–æ—Ñ–æ—Ä–º–∏—Ç—å */
.btn-outline-secondary {
    border-color: #6c757d;
    color: #6c757d;
    font-weight: 500;
}

.btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
}

.btn-success {
    background-color: #198754;
    border-color: #198754;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(25, 135, 84, 0.3);
}

.btn-success:hover {
    background-color: #157347;
    border-color: #146c43;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(25, 135, 84, 0.4);
}

/* –ü—É—Å—Ç–∞—è –∫–æ—Ä–∑–∏–Ω–∞ */
.alert-info {
    border-radius: 12px;
    border: 1px solid #b6d7ff;
    background-color: #e7f3ff;
    color: #0c5460;
}

.alert-info .btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    font-weight: 600;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .quantity-input-group {
        width: 120px;
    }

    .quantity-btn {
        width: 35px;
        height: 35px;
        font-size: 12px;
    }

    .quantity-input {
        width: 50px;
        min-width: 50px;
    }

    .table td, .table th {
        padding: 0.75rem 0.5rem !important;
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}
