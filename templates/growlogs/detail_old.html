{% extends "base.html" %}
{% load i18n humanize crispy_forms_tags %}

{% block title %}{{ growlog.title }} - {% trans "Гроу-репорт" %}{% endblock %}

{% block extra_head %}
<!-- Include SweetAlert2 for beautiful confirmations -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
.timeline-item {
    position: relative;
    padding-left: 25px;
    border-left: 2px solid #e9ecef;
}
.timeline-item::before {
    content: '';
    position: absolute;
    left: -8px;
    top: 5px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background-color: #0d6efd;
    border: 2px solid #fff;
}
.photo-thumbnail {
    width: 100px;
    height: 100px;
    object-fit: cover;
    margin: 5px;
    border-radius: .25rem;
    cursor: pointer;
}
.comment-author-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
}
.growlog-detail-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 20px 20px;
}
.growlog-logo-medium {
    width: 120px;
    height: 120px;
    object-fit: cover;
    border-radius: 12px;
    border: 3px solid rgba(255,255,255,0.3);
}
.growlog-logo-placeholder-medium {
    width: 120px;
    height: 120px;
    background: rgba(255,255,255,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 12px;
    border: 3px solid rgba(255,255,255,0.3);
    color: white;
    font-size: 2.5rem;
}
.stats-card {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1rem;
    height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-left: 1rem;
}
.stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    text-align: center;
}
.stat-item {
    display: flex;
    flex-direction: column;
}
.stat-value {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.1rem;
}
.stat-label {
    font-size: 0.75rem;
    opacity: 0.8;
}
.timeline-entry-card {
    border: none;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-radius: 15px;
    overflow: hidden;
}
.timeline-entry-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}
.about-card {
    border-radius: 12px;
    overflow: hidden;
}
.about-card .card-body {
    border-radius: 12px;
}

/* Стили для карточек параметров среды */
.environment-param-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.75rem;
    text-align: center;
    transition: all 0.3s ease;
    border: 1px solid #e9ecef;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.environment-param-card.temperature {
    background: linear-gradient(45deg, #ff6b6b20, #ff634720);
    border-color: #ff6b6b40;
}

.environment-param-card.humidity {
    background: linear-gradient(45deg, #4ecdc420, #45b7d120);
    border-color: #4ecdc440;
}

.environment-param-card.ph {
    background: linear-gradient(45deg, #95e1d320, #a8e6cf20);
    border-color: #95e1d340;
}

.environment-param-card.ec {
    background: linear-gradient(45deg, #ffd93d20, #ffeb3b20);
    border-color: #ffd93d40;
}

.environment-param-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.param-icon {
    font-size: 1.2rem;
    margin-bottom: 0.25rem;
    opacity: 0.8;
}

.temperature .param-icon { color: #ff6b6b; }
.humidity .param-icon { color: #4ecdc4; }
.ph .param-icon { color: #95e1d3; }
.ec .param-icon { color: #ffd93d; }

.param-value {
    display: flex;
    align-items: baseline;
    justify-content: center;
    gap: 0.25rem;
    margin-bottom: 0.25rem;
}

.param-value .value {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
}

.param-value .unit {
    font-size: 0.8rem;
    color: #6c757d;
    font-weight: 500;
}

.param-label {
    font-size: 0.7rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0;
}
</style>
{% endblock %}

{% block content %}
<!-- Заголовок с логотипом и статистикой -->
<div class="growlog-detail-header">
    <div class="container">
        <div class="row align-items-center justify-content-center">
            <!-- Только логотип -->
            <div class="col-auto">
                {% if growlog.logo %}
                    <img src="{{ growlog.logo.url }}" alt="{{ growlog.title }}" class="growlog-logo-medium">
                {% elif growlog.main_photo %}
                    <img src="{{ growlog.main_photo.url }}" alt="{{ growlog.title }}" class="growlog-logo-medium">
                {% else %}
                    <div class="growlog-logo-placeholder-medium">
                        <i class="fas fa-seedling"></i>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="row">
        <!-- Основная информация о гроу-репорте -->
        <div class="col-md-8">
            <div class="card about-card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <h3 class="card-title mb-0"><i class="fas fa-info-circle"></i> {% trans "О проекте" %}</h3>
                        <div>
                        {% if can_edit %}
                            <a href="{% url 'growlogs:edit' pk=growlog.pk %}" class="btn btn-sm btn-outline-primary me-2">
                                <i class="fas fa-edit"></i> {% trans "Редактировать" %}
                            </a>
                        {% endif %}
                        </div>
                    </div>
                    <hr>

                    {% if growlog.setup_description %}
                        <h5><i class="fas fa-tools"></i> {% trans "Описание сетапа" %}:</h5>
                        <p>{{ growlog.setup_description|linebreaksbr }}</p>
                    {% endif %}

                    {% if growlog.goals %}
                        <h5><i class="fas fa-bullseye"></i> {% trans "Цели" %}:</h5>
                        <p>{{ growlog.goals|linebreaksbr }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Таймлайн записей -->
            <h3 class="mb-3"><i class="fas fa-stream"></i> {% trans "Таймлайн" %}</h3>
            {% if timeline %}
                <div class="timeline">
                    {% for entry in timeline %}
                    <div class="timeline-entry-card card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <!-- Левая часть - основная информация о дне -->
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <h5 class="mb-1">
                                            <i class="fas fa-calendar-day"></i> {% trans "День" %} {{ entry.day }}
                                            <span class="badge bg-secondary ms-2">{{ entry.stage_display }}</span>
                                        </h5>
                                        <div class="d-flex gap-2">
                                            <small class="text-muted">{{ entry.date|date:"d.m.Y H:i" }}</small>
                                            {% if can_edit %}
                                                <a href="{% url 'growlogs:entry_edit' pk=entry.id %}"
                                                   class="btn btn-sm btn-outline-secondary"
                                                   title="{% trans 'Редактировать запись' %}">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>

                                    {% if entry.photos.all %}
                                    <div class="my-3 d-flex flex-wrap">
                                        {% for photo in entry.photos.all %}
                                            <img src="{{ photo.image.url }}" alt="{% trans "Фото дня" %} {{ entry.day }}" class="photo-thumbnail img-thumbnail">
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    {% if entry.activities %}
                                        <p><strong><i class="fas fa-clipboard-list"></i> Что сделано:</strong> {{ entry.activities|linebreaksbr }}</p>
                                    {% endif %}

                                    <!-- Лайки и комментарии к записи -->
                                    <div class="entry-social mt-3 pt-3 border-top">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="entry-stats">
                                                <button class="btn btn-sm btn-outline-danger entry-like-btn" data-entry-id="{{ entry.id }}">
                                                    <i class="fas fa-heart"></i>
                                                    <span class="likes-count">{{ entry.likes_count|default:0 }}</span>
                                                </button>
                                                <button class="btn btn-sm btn-outline-primary ms-2 toggle-comments-btn" data-entry-id="{{ entry.id }}">
                                                    <i class="fas fa-comment"></i>
                                                    <span class="comments-count">{{ entry.comments_count|default:0 }}</span>
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Комментарии к записи -->
                                        <div class="entry-comments" id="comments-{{ entry.id }}" style="display: none;">
                                            <div class="comments-list mb-3">
                                                {% for comment in entry.comments.all %}
                                                <div class="comment-item d-flex mb-2">
                                                    <img src="{{ comment.author.profile_extra.avatar.url|default:'/static/images/default_avatar.png' }}"
                                                         alt="{{ comment.author.username }}"
                                                         class="comment-author-avatar me-2"
                                                         style="width: 30px; height: 30px;">
                                                    <div class="flex-grow-1">
                                                        <strong>{{ comment.author.username }}</strong>
                                                        <small class="text-muted">{{ comment.created_at|naturaltime }}</small>
                                                        <p class="mb-0">{{ comment.text|linebreaksbr }}</p>
                                                    </div>
                                                </div>
                                                {% empty %}
                                                <p class="text-muted small">Комментариев пока нет</p>
                                                {% endfor %}
                                            </div>

                                            <!-- Форма комментария -->
                                            {% if user.is_authenticated %}
                                            <form class="add-comment-form" data-entry-id="{{ entry.id }}">
                                                {% csrf_token %}
                                                <div class="input-group">
                                                    <input type="text" class="form-control form-control-sm" name="text" placeholder="Написать комментарий...">
                                                    <button type="submit" class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </form>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Правая часть - параметры среды -->
                                <div class="col-md-4">
                                    <h6 class="mb-3"><i class="fas fa-thermometer-half"></i> {% trans "Параметры среды" %}</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <div class="environment-param-card temperature">
                                                <div class="param-icon">
                                                    <i class="fas fa-temperature-high"></i>
                                                </div>
                                                <div class="param-value">
                                                    {% if entry.temperature %}
                                                        <span class="value">{{ entry.temperature }}</span>
                                                        <small class="unit">°C</small>
                                                    {% else %}
                                                        <span class="value text-muted">Не указано</span>
                                                    {% endif %}
                                                </div>
                                                <small class="param-label">Температура</small>
                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="environment-param-card humidity">
                                                <div class="param-icon">
                                                    <i class="fas fa-tint"></i>
                                                </div>
                                                <div class="param-value">
                                                    {% if entry.humidity %}
                                                        <span class="value">{{ entry.humidity }}</span>
                                                        <small class="unit">%</small>
                                                    {% else %}
                                                        <span class="value text-muted">Не указано</span>
                                                    {% endif %}
                                                </div>
                                                <small class="param-label">Влажность</small>
                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="environment-param-card ph">
                                                <div class="param-icon">
                                                    <i class="fas fa-vial"></i>
                                                </div>
                                                <div class="param-value">
                                                    {% if entry.ph %}
                                                        <span class="value">{{ entry.ph }}</span>
                                                        <small class="unit">pH</small>
                                                    {% else %}
                                                        <span class="value text-muted">Не указано</span>
                                                    {% endif %}
                                                </div>
                                                <small class="param-label">PH</small>
                                            </div>
                                        </div>

                                        <div class="col-6">
                                            <div class="environment-param-card ec">
                                                <div class="param-icon">
                                                    <i class="fas fa-bolt"></i>
                                                </div>
                                                <div class="param-value">
                                                    {% if entry.ec %}
                                                        <span class="value">{{ entry.ec }}</span>
                                                        <small class="unit">мС/см</small>
                                                    {% else %}
                                                        <span class="value text-muted">Не указано</span>
                                                    {% endif %}
                                                </div>
                                                <small class="param-label">EC (мС/см)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> {% trans "Записей в таймлайне пока нет." %}
                    {% if can_edit %}
                        <a href="{% url 'growlogs:entry_create' pk=growlog.pk %}" class="btn btn-sm btn-primary ms-3">
                            <i class="fas fa-plus"></i> {% trans "Добавить первую запись" %}
                        </a>
                    {% endif %}
                </div>
            {% endif %}

            <!-- Кнопка добавления записи -->
            {% if can_edit and timeline %}
                <div class="text-center mb-4">
                    <a href="{% url 'growlogs:entry_create' pk=growlog.pk %}" class="btn btn-success">
                        <i class="fas fa-plus"></i> {% trans "Добавить запись в таймлайн" %}
                    </a>
                </div>
            {% endif %}

            <!-- Комментарии к гроу-репорту -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-comments"></i> {% trans "Комментарии" %} ({{ comments.count }})</h5>
                </div>
                <div class="card-body">
                    {% if user.is_authenticated %}
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col">
                                <textarea name="text" class="form-control" placeholder="Ваш комментарий..." required></textarea>
                            </div>
                            <div class="col-auto">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> {% trans "Отправить" %}
                                </button>
                            </div>
                        </div>
                    </form>
                {% else %}
                    <p><a href="{% url 'account_login' %}?next={{ request.path }}">{% trans "Войдите" %}</a>, {% trans "чтобы оставить комментарий." %}</p>
                {% endif %}

                {% for comment in comments %}
                <div class="d-flex mb-3">
                    <img src="{{ comment.author.profile_extra.avatar.url|default:'/static/images/default_avatar.png' }}" alt="{{ comment.author.username }}" class="comment-author-avatar me-3">
                    <div class="flex-grow-1">
                        <strong>{{ comment.author.username }}</strong> <small class="text-muted">{{ comment.created_at|naturaltime }}</small>
                        <p>{{ comment.text|linebreaksbr }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted"><i class="fas fa-comment-slash"></i> {% trans "Комментариев пока нет. Будьте первым!" %}</p>
                {% endfor %}
            </div>
        </div>

        <!-- Боковая панель с информацией -->
        <div class="col-md-4">
            <!-- Информация о гроу-репорте -->
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0"><i class="fas fa-seedling"></i> {{ growlog.title }}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <span class="badge bg-{% if growlog.is_public %}success{% else %}warning{% endif %} fs-6">
                            {% if growlog.is_public %}<i class="fas fa-eye"></i> {% trans "Публичный" %}{% else %}<i class="fas fa-lock"></i> {% trans "Приватный" %}{% endif %}
                        </span>
                        <span class="badge bg-info fs-6">{{ growlog.get_current_stage_display }}</span>
                        <span class="badge bg-secondary fs-6">{{ growlog.get_environment_display }}</span>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="h5 mb-0">{{ stats.total_days }}</div>
                                <small class="text-muted">Дней</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-0">{{ stats.total_entries }}</div>
                            <small class="text-muted">Записей</small>
                        </div>
                    </div>

                    <hr class="my-3">

                    <div class="small">
                        <div class="mb-2">
                            <i class="fas fa-user text-muted"></i> {% trans "Автор" %}:
                            {% if growlog.grower.username %}
                                {% url 'users:detail' username=growlog.grower.username as user_url %}
                                {% if user_url %}
                                    <a href="{{ user_url }}" class="text-decoration-none">{{ growlog.grower.username }}</a>
                                {% else %}
                                    {{ growlog.grower.username }}
                                {% endif %}
                            {% else %}
                                {{ growlog.grower.username }}
                            {% endif %}
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-calendar-alt text-muted"></i> День {{ growlog.current_day }}
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-eye text-muted"></i> {{ growlog.views_count|intcomma }} {% trans "просмотров" %}
                        </div>
                        <div class="mb-2">
                            <a href="#" id="like-growlog-btn" data-growlog-id="{{ growlog.pk }}" class="text-decoration-none {% if user_liked %}text-danger{% else %}text-muted{% endif %}">
                                <i class="fas fa-heart{% if not user_liked %}-o{% endif %}"></i> <span id="likes-count">{{ likes_count|intcomma }}</span> лайков
                            </a>
                        </div>
                        <div>
                            <i class="fas fa-comments text-muted"></i> {{ comments.count|intcomma }} комментариев
                        </div>
                    </div>
                </div>
            </div>

            {% with strain_info=growlog.get_strain_display %}
                {% if strain_info.name != 'N/A' %}
                <div class="card mb-3">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> {% trans "Информация о сорте" %}</h6>
                    </div>
                    <div class="card-body">
                        <h5><strong>{{ strain_info.name }}</strong>
                        {% if strain_info.from_store %}
                            {% if growlog.strain.get_strain_type_display %}
                                <small class="text-muted">({{ growlog.strain.get_strain_type_display }})</small>
                            {% endif %}
                        {% endif %}
                        </h5>

                        {% if strain_info.seedbank %}
                            <p><strong>{% trans "Сидбанк" %}:</strong> {{ strain_info.seedbank }}</p>
                        {% elif not strain_info.from_store %}
                            <p class="text-muted small"><i class="fas fa-info-circle"></i> Произвольный сорт</p>
                        {% endif %}

                        {% if strain_info.from_store and growlog.strain.description %}
                            <p class="small text-muted">{{ growlog.strain.description|truncatewords:30|linebreaksbr }}</p>
                        {% endif %}

                        {% if strain_info.from_store and strain_info.url %}
                            <div class="d-grid">
                                <a href="{{ strain_info.url }}" class="btn btn-outline-primary">
                                    <i class="fas fa-external-link-alt"></i> {% trans "Смотреть в магазине" %}
                                </a>
                            </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <small class="text-muted">{% trans "Последнее обновление" %}: {{ growlog.updated_at|naturaltime }}</small>
                    </div>
                </div>
                {% endif %}
            {% endwith %}

            <!-- Панель с текущими параметрами среды -->
            {% if latest_environment %}
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-thermometer-half"></i> {% trans "Параметры среды" %}</h6>
                    <small class="opacity-75">День {{ latest_environment.day }} • {{ latest_environment.date|date:"d.m.Y" }}</small>
                </div>
                <div class="card-body p-2">
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="environment-param-card temperature">
                                <div class="param-icon">
                                    <i class="fas fa-temperature-high"></i>
                                </div>
                                <div class="param-value">
                                    {% if latest_environment.temperature %}
                                        <span class="value">{{ latest_environment.temperature }}</span>
                                        <small class="unit">°C</small>
                                    {% else %}
                                        <span class="value text-muted">Не указано</span>
                                    {% endif %}
                                </div>
                                <small class="param-label">Температура</small>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="environment-param-card humidity">
                                <div class="param-icon">
                                    <i class="fas fa-tint"></i>
                                </div>
                                <div class="param-value">
                                    {% if latest_environment.humidity %}
                                        <span class="value">{{ latest_environment.humidity }}</span>
                                        <small class="unit">%</small>
                                    {% else %}
                                        <span class="value text-muted">Не указано</span>
                                    {% endif %}
                                </div>
                                <small class="param-label">Влажность</small>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="environment-param-card ph">
                                <div class="param-icon">
                                    <i class="fas fa-vial"></i>
                                </div>
                                <div class="param-value">
                                    {% if latest_environment.ph %}
                                        <span class="value">{{ latest_environment.ph }}</span>
                                        <small class="unit">pH</small>
                                    {% else %}
                                        <span class="value text-muted">Не указано</span>
                                    {% endif %}
                                </div>
                                <small class="param-label">PH</small>
                            </div>
                        </div>

                        <div class="col-6">
                            <div class="environment-param-card ec">
                                <div class="param-icon">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div class="param-value">
                                    {% if latest_environment.ec %}
                                        <span class="value">{{ latest_environment.ec }}</span>
                                        <small class="unit">мС/см</small>
                                    {% else %}
                                        <span class="value text-muted">Не указано</span>
                                    {% endif %}
                                </div>
                                <small class="param-label">EC (мС/см)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для просмотра фото -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="photoModalLabel">{% trans "Просмотр фото" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" id="modalImage" class="img-fluid rounded" alt="{% trans "Фото из гроу-репорта" %}">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Лайки гроу-репорта
    const likeButton = document.getElementById('like-growlog-btn');
    if (likeButton) {
        likeButton.addEventListener('click', function(e) {
            e.preventDefault();
            const growlogId = this.dataset.growlogId;
            const url = "{% url 'growlogs:toggle_like' pk=0 %}".replace('0', growlogId);

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.liked) {
                    this.classList.remove('text-muted');
                    this.classList.add('text-danger');
                    this.querySelector('i').classList.remove('fa-heart-o');
                    this.querySelector('i').classList.add('fa-heart');
                } else {
                    this.classList.remove('text-danger');
                    this.classList.add('text-muted');
                    this.querySelector('i').classList.remove('fa-heart');
                    this.querySelector('i').classList.add('fa-heart-o');
                }
                document.getElementById('likes-count').textContent = data.likes_count;
            })
            .catch(error => console.error('Error liking growlog:', error));
        });
    }

    // Модальное окно для фото
    const photoModal = new bootstrap.Modal(document.getElementById('photoModal'));
    const modalImage = document.getElementById('modalImage');
    document.querySelectorAll('.photo-thumbnail').forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
            modalImage.src = this.src.replace('/thumbnail/', '/');
            photoModal.show();
        });
    });

    // Лайки записей
    document.addEventListener('click', function(e) {
        if (e.target.closest('.entry-like-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.entry-like-btn');
            const entryId = btn.dataset.entryId;

            fetch(`{% url 'growlogs:toggle_entry_like' entry_id=0 %}`.replace('0', entryId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const likesSpan = btn.querySelector('.likes-count');
                    likesSpan.textContent = data.likes_count;

                    // Анимация
                    btn.style.transform = 'scale(1.1)';
                    setTimeout(() => btn.style.transform = 'scale(1)', 200);

                    // Изменяем стиль кнопки
                    if (data.action === 'liked') {
                        btn.classList.remove('btn-outline-danger');
                        btn.classList.add('btn-danger');
                    } else {
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-danger');
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });

    // Переключение комментариев
    document.addEventListener('click', function(e) {
        if (e.target.closest('.toggle-comments-btn')) {
            e.preventDefault();
            const btn = e.target.closest('.toggle-comments-btn');
            const entryId = btn.dataset.entryId;
            const commentsDiv = document.getElementById(`comments-${entryId}`);

            if (commentsDiv.style.display === 'none') {
                commentsDiv.style.display = 'block';
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            } else {
                commentsDiv.style.display = 'none';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            }
        }
    });

    // Отправка комментариев к записям
    document.addEventListener('submit', function(e) {
        if (e.target.classList.contains('add-comment-form')) {
            e.preventDefault();
            const form = e.target;
            const entryId = form.dataset.entryId;
            const formData = new FormData(form);

            fetch(`{% url 'growlogs:add_entry_comment' entry_id=0 %}`.replace('0', entryId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    // Добавляем новый комментарий
                    const commentsList = form.parentElement.querySelector('.comments-list');
                    const newComment = document.createElement('div');
                    newComment.className = 'comment-item d-flex mb-2';
                    newComment.innerHTML = `
                        <img src="${data.comment.author_avatar}"
                             alt="${data.comment.author}"
                             class="comment-author-avatar me-2"
                             style="width: 30px; height: 30px;">
                        <div class="flex-grow-1">
                            <strong>${data.comment.author}</strong>
                            <small class="text-muted">${data.comment.created_at}</small>
                            <p class="mb-0 small">${data.comment.text}</p>
                        </div>
                    `;

                    // Удаляем сообщение "Комментариев пока нет"
                    const noComments = commentsList.querySelector('.text-muted');
                    if (noComments && noComments.textContent.includes('Комментариев пока нет')) {
                        noComments.remove();
                    }

                    commentsList.appendChild(newComment);

                    // Обновляем счетчик
                    const commentsBtn = document.querySelector(`[data-entry-id="${entryId}"].toggle-comments-btn`);
                    const commentsCount = commentsBtn.querySelector('.comments-count');
                    commentsCount.textContent = data.comments_count;

                    // Очищаем форму
                    form.reset();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Ошибка',
                        text: 'Не удалось добавить комментарий'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Ошибка сети',
                    text: 'Проверьте подключение к интернету'
                });
            });
        }
    });
});
</script>
{% endblock %}
