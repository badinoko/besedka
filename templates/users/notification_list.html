{% extends "base.html" %}
{% load i18n static %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-item {
        border-radius: 0.75rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 1px solid #e9ecef;
        background: #ffffff;
        position: relative;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    /* –≠—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    .notification-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1), 0 0.75rem 1.5rem rgba(0,0,0,0.15) !important;
        border-color: #007bff;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-item.unread {
        background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 100%);
        border-left: 4px solid #007bff;
        box-shadow: 0 0.125rem 0.25rem rgba(0,123,255,0.1);
    }

    .notification-item.unread:hover {
        background: linear-gradient(135deg, #f0f4ff 0%, #ffffff 100%);
        border-left-color: #0056b3;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-item.read {
        background: #ffffff;
        border-left: 4px solid #6c757d;
        opacity: 0.85;
    }

    .notification-item.read:hover {
        opacity: 1;
        border-left-color: #495057;
    }

    /* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification-item.clickable {
        cursor: pointer;
        position: relative;
    }

    .notification-item.clickable::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 0%, rgba(0,123,255,0.02) 50%, transparent 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .notification-item.clickable:hover::before {
        opacity: 1;
    }

    /* –ò–∫–æ–Ω–∫–∞ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
    .clickable-icon {
        position: absolute;
        top: 12px;
        right: 12px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 8px rgba(0,123,255,0.3);
    }

    .notification-item.clickable:hover .clickable-icon {
        opacity: 1;
        transform: scale(1);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification-title {
        font-weight: 600;
        color: #212529;
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
        line-height: 1.3;
    }

    .notification-item.unread .notification-title {
        color: #0056b3;
    }

    /* –¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
    .notification-message {
        color: #6c757d;
        line-height: 1.5;
        margin-bottom: 0.75rem;
    }

    /* –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
    .notification-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.875rem;
        color: #868e96;
        margin-top: auto;
    }

    .notification-date {
        font-weight: 500;
    }

    .notification-type {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 500;
        color: #495057;
    }

    .notification-item.unread .notification-type {
        background: #e3f2fd;
        color: #1976d2;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    .notification-item {
        animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π */
    .notification-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #e9ecef;
    }

    .notification-actions .btn {
        font-size: 0.875rem;
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        transition: all 0.2s ease;
    }

    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    .notification-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 1rem 1rem;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
    }

    .notification-header h1 {
        margin: 0;
        font-weight: 700;
        font-size: 2.5rem;
    }

    .notification-header .fas.fa-bell {
        color: #ffd700;
        text-shadow: 0 2px 4px rgba(255, 215, 0, 0.3);
        animation: bellRing 2s ease-in-out infinite;
    }

    @keyframes bellRing {
        0%, 100% { transform: rotate(0deg); }
        10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
        20%, 40%, 60%, 80% { transform: rotate(10deg); }
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ TOTAL */
    .stats-card {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }

    .stats-card:hover {
        background: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
    }

    .stats-number {
        font-size: 2.2rem;
        font-weight: 800;
        color: #ffd700;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        line-height: 1;
        margin-bottom: 0.25rem;
    }

    .stats-card .small {
        font-size: 0.9rem;
        opacity: 0.9;
        font-weight: 500;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */
    .filter-tabs {
        background: #f8f9fa;
        border-radius: 1rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .filter-tab {
        background: white;
        border: 2px solid #e9ecef;
        color: #6c757d;
        padding: 0.75rem 1.25rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        margin: 0.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .filter-tab:hover {
        background: #f8f9fa;
        border-color: #007bff;
        color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.2);
    }

    .filter-tab.active {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border-color: #0056b3;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        transform: translateY(-1px);
    }

    .filter-tab i {
        margin-right: 0.5rem;
    }

    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –º–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */
    .bulk-actions {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 1rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .bulk-actions .btn-group .btn {
        border-radius: 0.75rem;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        margin: 0 0.25rem;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .bulk-actions .btn-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .bulk-actions .btn-primary {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
    }

    .bulk-actions .btn-primary:hover {
        background: linear-gradient(135deg, #218838, #1e7e5a);
    }

    .bulk-actions .btn-outline-primary:hover {
        background: linear-gradient(135deg, #007bff, #0056b3);
    }

    .bulk-actions .btn-outline-danger:hover {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }

    /* –°—á–µ—Ç—á–∏–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-count {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
        display: inline-block;
        margin-left: 1rem;
        box-shadow: 0 2px 8px rgba(40,167,69,0.3);
    }

    /* –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ" */
    .mark-all-read-btn {
        background: linear-gradient(135deg, #6f42c1, #5a2d91);
        border: none;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(111,66,193,0.3);
    }

    .mark-all-read-btn:hover {
        background: linear-gradient(135deg, #5a2d91, #4c2a85);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(111,66,193,0.4);
        color: white;
    }

    /* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #dee2e6;
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .notification-item {
            margin-bottom: 0.75rem;
        }

        .notification-title {
            font-size: 1rem;
        }

        .notification-meta {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .clickable-icon {
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            font-size: 10px;
        }
    }

    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .notification-item.clickable:active {
        transform: translateY(-2px) scale(0.98);
    }

    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ –±–æ—Ä–¥–µ—Ä—ã –¥–ª—è –æ—Å–æ–±—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
    .notification-item.priority-high {
        border-left: 4px solid #dc3545;
        background: linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);
    }

    .notification-item.priority-high:hover {
        background: linear-gradient(135deg, #ffebee 0%, #ffffff 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="notification-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-bell me-3"></i>{{ page_title }}
                </h1>
                <p class="mb-0 mt-2 opacity-75">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="stats-card d-inline-block">
                    <div class="stats-number" id="total-count-display">{{ total_count }}</div>
                    <div class="small">{% trans "–í—Å–µ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π" %}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    {% if notifications %}
        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="filter-tabs">
            <div class="d-flex flex-wrap justify-content-center">
                <button class="filter-tab active" data-filter="all">
                    <i class="fas fa-list me-2"></i>{% trans "–í—Å–µ" %} (<span id="all-count">{{ total_count }}</span>)
                </button>
                <button class="filter-tab" data-filter="unread">
                    <i class="fas fa-envelope me-2"></i>{% trans "–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ" %} (<span id="unread-count">{{ unread_count|default:0 }}</span>)
                </button>
                <button class="filter-tab" data-filter="system">
                    <i class="fas fa-cog me-2"></i>{% trans "–°–∏—Å—Ç–µ–º–Ω—ã–µ" %}
                </button>
                <button class="filter-tab" data-filter="social">
                    <i class="fas fa-users me-2"></i>{% trans "–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ" %}
                </button>
                <button class="filter-tab" data-filter="orders">
                    <i class="fas fa-shopping-cart me-2"></i>{% trans "–ó–∞–∫–∞–∑—ã" %}
                </button>
            </div>
        </div>

        <!-- –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="bulk-actions">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label fw-bold" for="selectAll">
                            {% trans "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" %}
                        </label>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="markSelectedRead" disabled>
                            <i class="fas fa-check me-1"></i>{% trans "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" %}
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteSelected" disabled>
                            <i class="fas fa-trash me-1"></i>{% trans "–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ" %}
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" id="markAllRead">
                            <i class="fas fa-check-double me-1"></i>{% trans "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
        <div class="notifications-list">
            {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% else %}read{% endif %} {% if notification.is_actionable %}clickable{% endif %}"
                     data-type="{{ notification.notification_type }}"
                     data-read="{{ notification.is_read|yesno:'true,false' }}"
                     data-notification-id="{{ notification.id }}"
                     {% if notification.is_actionable %}data-action-url="{{ notification.get_action_url }}"{% endif %}>

                    {% if notification.is_actionable %}
                        <div class="clickable-icon">üîó</div>
                    {% endif %}

                    <div class="card-body">
                        <div class="d-flex align-items-start">
                            <!-- –ß–µ–∫–±–æ–∫—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ -->
                            <div class="me-3">
                                <input type="checkbox" class="form-check-input notification-checkbox"
                                       data-notification-id="{{ notification.id }}">
                            </div>

                            <div class="notification-content flex-grow-1">
                                <h5 class="notification-title">{{ notification.title }}</h5>
                                <p class="notification-message">{{ notification.message }}</p>

                                <div class="notification-meta">
                                    <span class="notification-date">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ notification.created_at|timesince }} –Ω–∞–∑–∞–¥
                                    </span>
                                    <span class="notification-type">
                                        {{ notification.get_notification_type_display }}
                                    </span>
                                    {% if not notification.is_read %}
                                        <span class="badge bg-warning text-dark ms-2">–ù–æ–≤–æ–µ</span>
                                    {% endif %}
                                </div>

                                <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
                                <div class="notification-actions">
                                    {% if not notification.is_read %}
                                        <button type="button" class="btn btn-outline-primary btn-sm mark-read-btn"
                                                data-notification-id="{{ notification.id }}">
                                            <i class="fas fa-check me-1"></i>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                                        </button>
                                    {% endif %}

                                    <button type="button" class="btn btn-outline-danger btn-sm delete-single-btn"
                                            data-notification-id="{{ notification.id }}">
                                        <i class="fas fa-trash me-1"></i>–£–¥–∞–ª–∏—Ç—å
                                    </button>

                                    {% if notification.is_actionable and notification.get_action_url %}
                                        <a href="{{ notification.get_action_url }}" class="btn btn-outline-info btn-sm">
                                            <i class="fas fa-external-link-alt me-1"></i>–ü–µ—Ä–µ–π—Ç–∏
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if is_paginated %}
            <nav aria-label="{% trans '–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º' %}">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">{% trans "–ü–µ—Ä–≤–∞—è" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "–ü—Ä–µ–¥—ã–¥—É—â–∞—è" %}</a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            {% trans "–°—Ç—Ä–∞–Ω–∏—Ü–∞" %} {{ page_obj.number }} {% trans "–∏–∑" %} {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "–°–ª–µ–¥—É—é—â–∞—è" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{% trans "–ü–æ—Å–ª–µ–¥–Ω—è—è" %}</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

    {% else %}
        <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-bell-slash"></i>
            </div>
            <h3>{% trans "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π" %}</h3>
            <p class="text-muted">{% trans "–ö–æ–≥–¥–∞ –ø–æ—è–≤—è—Ç—Å—è –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –æ–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å" %}</p>
        </div>
    {% endif %}

    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
    <div class="text-center mt-4 mb-5">
        <a href="{% url 'users:profile' %}" class="btn btn-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>{% trans "–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" %}
        </a>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalText">{% trans "–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è?" %}</p>
                <p class="text-muted small">{% trans "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å." %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "–û—Ç–º–µ–Ω–∞" %}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{% trans "–£–¥–∞–ª–∏—Ç—å" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="toast-container"></div>

{% endblock %}

{% block extra_js %}
{% csrf_token %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –≠–ª–µ–º–µ–Ω—Ç—ã
    const selectAllCheckbox = document.getElementById('selectAll');
    const notificationCheckboxes = document.querySelectorAll('.notification-checkbox');
    const markSelectedReadBtn = document.getElementById('markSelectedRead');
    const deleteSelectedBtn = document.getElementById('deleteSelected');
    const markAllReadBtn = document.getElementById('markAllRead');
    const filterTabs = document.querySelectorAll('.filter-tab');
    const notificationCards = document.querySelectorAll('.notification-item');

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
    function updateAllCounters(serverUnreadCount = null, serverTotalCount = null) {
        console.log('[DEBUG] updateAllCounters called with:', {
            serverUnreadCount: serverUnreadCount,
            serverTotalCount: serverTotalCount
        });

        // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –í–ò–î–ò–ú–´–ï –∫–∞—Ä—Ç–æ—á–∫–∏ (–Ω–µ —Å–∫—Ä—ã—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)
        const visibleCards = document.querySelectorAll('.notification-item:not([style*="display: none"])');
        const visibleUnreadCards = document.querySelectorAll('.notification-item.unread:not([style*="display: none"])');

        const unreadOnPage = visibleUnreadCards.length;
        const totalOnPage = visibleCards.length;

        console.log('[DEBUG] Page counts:', {
            visibleCards: totalOnPage,
            visibleUnreadCards: unreadOnPage
        });

        // üîî –°–ß–ï–¢–ß–ò–ö –í –®–ê–ü–ö–ï - –ù–ï–ü–†–û–ß–ò–¢–ê–ù–ù–´–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
        const currentUnreadForBadge = serverUnreadCount !== null ? serverUnreadCount : unreadOnPage;
        console.log('[DEBUG] Badge update - currentUnreadForBadge:', currentUnreadForBadge);

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        updateNotificationBadge(currentUnreadForBadge);

        // üìä –°–ß–ï–¢–ß–ò–ö–ò –ù–ê –°–¢–†–ê–ù–ò–¶–ï
        const unreadCountElement = document.getElementById('unread-count');
        const allCountElement = document.getElementById('all-count');
        const totalCountDisplay = document.getElementById('total-count-display');

        if (unreadCountElement) {
            unreadCountElement.textContent = serverUnreadCount !== null ? serverUnreadCount : unreadOnPage;
        }

        if (allCountElement) {
            allCountElement.textContent = serverTotalCount !== null ? serverTotalCount : totalOnPage;
        }

        if (totalCountDisplay) {
            totalCountDisplay.textContent = serverTotalCount !== null ? serverTotalCount : totalOnPage;
        }

        console.log('[DEBUG] Updated page counters:', {
            unread: serverUnreadCount !== null ? serverUnreadCount : unreadOnPage,
            total: serverTotalCount !== null ? serverTotalCount : totalOnPage
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function updateNotificationBadge(count) {
        console.log('[DEBUG] updateNotificationBadge called with count:', count);

        // –ò—â–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ —à–∞–ø–∫–µ
        let badge = document.querySelector('.nav-counter-badge.notifications-badge');
        if (!badge) {
            badge = document.querySelector('.notifications-badge');
        }
        if (!badge) {
            badge = document.querySelector('[class*="notifications-badge"]');
        }

        console.log('[DEBUG] Badge element found:', badge);

        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'flex';
                console.log('[DEBUG] Badge updated - showing count:', count);
            } else {
                badge.style.display = 'none';
                console.log('[DEBUG] Badge hidden - count is 0');
            }
        } else {
            console.warn('[DEBUG] Badge element not found');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (Toast)
    function showToast(message, type = 'success') {
        const toastContainer = document.querySelector('.toast-container');
        const toastId = 'toast-' + Date.now();

        const toastHtml = `
            <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0"
                 role="alert" aria-live="assertive" aria-atomic="true" id="${toastId}">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, {
            autohide: true,
            delay: 3000
        });

        toast.show();

        // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
        toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–º–µ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ
    function markSingleNotificationRead(notificationId, buttonElement = null, cardElement = null, callback = null) {
        console.log('[DEBUG] markSingleNotificationRead called:', {
            notificationId,
            hasButton: !!buttonElement,
            hasCard: !!cardElement,
            hasCallback: !!callback
        });

        fetch(`/users/cabinet/notifications/${notificationId}/mark-read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] markSingleNotificationRead response:', data);

            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                const card = cardElement || document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (card) {
                    card.classList.remove('unread');
                    card.classList.add('read');
                    card.dataset.read = 'true';

                    // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂ "–ù–æ–≤–æ–µ"
                    const newBadge = card.querySelector('.badge.bg-warning');
                    if (newBadge) {
                        newBadge.remove();
                    }
                }

                // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
                if (buttonElement) {
                    buttonElement.style.display = 'none';
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateAllCounters(data.unread_notifications_count, data.total_notifications_count);

                // –í—ã–ø–æ–ª–Ω—è–µ–º callback, –µ—Å–ª–∏ –µ—Å—Ç—å
                if (callback) {
                    callback();
                } else {
                    showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ', 'success');
                }
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
            }
        })
        .catch(error => {
            console.error('[DEBUG] Error in markSingleNotificationRead:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ"
    function markAllAsRead() {
        fetch('/users/cabinet/notifications/read-all/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                document.querySelectorAll('.notification-item').forEach(item => {
                    item.classList.remove('unread');
                    item.classList.add('read');
                    item.dataset.read = 'true';

                    // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂–∏ "–ù–æ–≤–æ–µ"
                    const newBadge = item.querySelector('.badge.bg-warning');
                    if (newBadge) {
                        newBadge.remove();
                    }

                    // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
                    const readBtn = item.querySelector('.mark-read-btn');
                    if (readBtn) {
                        readBtn.style.display = 'none';
                    }
                });

                // –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                updateNotificationBadge(data.unread_count);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                updateAllCounters(data.unread_count, data.total_count);

                showToast('–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ', 'success');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'error');
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    if (markAllReadBtn) {
        markAllReadBtn.addEventListener('click', markAllAsRead);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–∞–º "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
    document.addEventListener('click', function(e) {
        if (e.target.closest('.mark-read-btn')) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            const button = e.target.closest('.mark-read-btn');
            const notificationId = button.dataset.notificationId;
            markSingleNotificationRead(notificationId, button);
        }
    });

    // –£–ú–ù–ê–Ø –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–û–°–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    document.querySelectorAll('.notification-item.clickable').forEach(card => {
        card.addEventListener('click', function(e) {
            // –ò—Å–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –ø–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞–º –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
            if (e.target.closest('.notification-checkbox, .btn, a, button, input')) {
                console.log('[DEBUG] Click ignored - clicked on interactive element:', e.target);
                return;
            }

            const notificationId = this.dataset.notificationId;
            const actionUrl = this.dataset.actionUrl;
            const isRead = this.dataset.read === 'true';

            console.log('[DEBUG] Card clicked:', {
                notificationId,
                actionUrl,
                isRead,
                hasActionUrl: actionUrl && actionUrl !== 'None' && actionUrl !== '#'
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            this.classList.add('clicking');
            setTimeout(() => {
                this.classList.remove('clicking');
            }, 150);

            if (!isRead) {
                // –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ, —Å–Ω–∞—á–∞–ª–∞ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                console.log('[DEBUG] Marking notification as read before action');
                markSingleNotificationRead(notificationId, null, this, () => {
                    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø–æ–º–µ—Ç–∫–∏ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥
                    if (actionUrl && actionUrl !== 'None' && actionUrl !== '#') {
                        console.log('[DEBUG] Redirecting to:', actionUrl);
                        window.location.href = actionUrl;
                    } else {
                        console.log('[DEBUG] No action URL, just marked as read');
                        showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ', 'success');
                    }
                });
            } else {
                // –ï—Å–ª–∏ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ –∏ –µ—Å—Ç—å actionUrl, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º
                if (actionUrl && actionUrl !== 'None' && actionUrl !== '#') {
                    console.log('[DEBUG] Already read, redirecting to:', actionUrl);
                    window.location.href = actionUrl;
                } else {
                    console.log('[DEBUG] Already read, no action URL');
                    showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–∂–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ', 'info');
                }
            }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        card.addEventListener('mouseenter', function() {
            if (this.classList.contains('clickable')) {
                this.style.cursor = 'pointer';
            }
        });
    });

    // –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –û–î–ù–û–ì–û –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    function deleteSingleNotification(notificationId, buttonElement = null) {
        console.log('[DEBUG] deleteSingleNotification called:', notificationId);

        fetch(`/users/cabinet/notifications/delete/${notificationId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] deleteSingleNotification response:', data);

            if (data.success) {
                // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–∑ DOM
                const card = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (card) {
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'translateX(-100%)';

                    setTimeout(() => {
                        card.remove();
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
                        updateAllCounters(data.unread_notifications_count, data.total_notifications_count);

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                        const remainingNotifications = document.querySelectorAll('.notification-item');
                        if (remainingNotifications.length === 0) {
                            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                        }
                    }, 300);
                }

                showToast('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
            }
        })
        .catch(error => {
            console.error('[DEBUG] Error in deleteSingleNotification:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
        });
    }

    // –§–£–ù–ö–¶–ò–Ø –£–î–ê–õ–ï–ù–ò–Ø –í–´–ë–†–ê–ù–ù–´–• –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    function deleteSelectedNotifications() {
        const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
        const notificationIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.notificationId);

        if (notificationIds.length === 0) {
            showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            return;
        }

        console.log('[DEBUG] deleteSelectedNotifications called:', notificationIds);

        fetch('/users/cabinet/notifications/delete-multiple/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                notification_ids: notificationIds
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] deleteSelectedNotifications response:', data);

            if (data.success) {
                // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ DOM
                notificationIds.forEach(id => {
                    const card = document.querySelector(`[data-notification-id="${id}"]`);
                    if (card) {
                        card.style.transition = 'all 0.3s ease';
                        card.style.opacity = '0';
                        card.style.transform = 'translateX(-100%)';

                        setTimeout(() => {
                            card.remove();
                        }, 300);
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                setTimeout(() => {
                    updateAllCounters(data.unread_notifications_count, data.total_notifications_count);

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    const remainingNotifications = document.querySelectorAll('.notification-item');
                    if (remainingNotifications.length === 0) {
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                    }
                }, 300);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                selectAllCheckbox.checked = false;
                updateBulkActionButtons();

                showToast(`–£–¥–∞–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${data.deleted_count}`, 'success');
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'error');
            }
        })
        .catch(error => {
            console.error('[DEBUG] Error in deleteSelectedNotifications:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'error');
        });
    }

    // –§–£–ù–ö–¶–ò–Ø –ü–û–ú–ï–¢–ö–ò –í–´–ë–†–ê–ù–ù–´–• –ö–ê–ö –ü–†–û–ß–ò–¢–ê–ù–ù–´–•
    function markSelectedAsRead() {
        const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
        const notificationIds = Array.from(selectedCheckboxes).map(cb => cb.dataset.notificationId);

        if (notificationIds.length === 0) {
            showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –ø–æ–º–µ—Ç–∫–∏', 'error');
            return;
        }

        console.log('[DEBUG] markSelectedAsRead called:', notificationIds);

        fetch('/users/cabinet/notifications/read-multiple/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                notification_ids: notificationIds
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('[DEBUG] markSelectedAsRead response:', data);

            if (data.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫
                notificationIds.forEach(id => {
                    const card = document.querySelector(`[data-notification-id="${id}"]`);
                    if (card) {
                        card.classList.remove('unread');
                        card.classList.add('read');
                        card.dataset.read = 'true';

                        // –£–¥–∞–ª—è–µ–º –±–µ–π–¥–∂ "–ù–æ–≤–æ–µ"
                        const newBadge = card.querySelector('.badge.bg-warning');
                        if (newBadge) {
                            newBadge.remove();
                        }

                        // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ"
                        const readBtn = card.querySelector('.mark-read-btn');
                        if (readBtn) {
                            readBtn.style.display = 'none';
                        }
                    }
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                updateAllCounters(data.unread_notifications_count, data.total_notifications_count);

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                selectAllCheckbox.checked = false;
                updateBulkActionButtons();

                showToast(`–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ: ${data.updated_count} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`, 'success');
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'error');
            }
        })
        .catch(error => {
            console.error('[DEBUG] Error in markSelectedAsRead:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'error');
        });
    }

    // –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–û–°–¢–û–Ø–ù–ò–Ø –ö–ù–û–ü–û–ö –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô
    function updateBulkActionButtons() {
        const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
        const hasSelected = selectedCheckboxes.length > 0;

        if (markSelectedReadBtn) {
            markSelectedReadBtn.disabled = !hasSelected;
        }
        if (deleteSelectedBtn) {
            deleteSelectedBtn.disabled = !hasSelected;
        }
    }

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô –î–õ–Ø –ö–ù–û–ü–û–ö –£–î–ê–õ–ï–ù–ò–Ø
    document.addEventListener('click', function(e) {
        // –£–¥–∞–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        if (e.target.closest('.delete-single-btn')) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            const button = e.target.closest('.delete-single-btn');
            const notificationId = button.dataset.notificationId;

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById('deleteModalText').textContent = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?';

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.onclick = function() {
                deleteSingleNotification(notificationId, button);
                modal.hide();
            };

            modal.show();
        }
    });

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ú–ê–°–°–û–í–´–• –î–ï–ô–°–¢–í–ò–ô
    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', function() {
            const selectedCount = document.querySelectorAll('.notification-checkbox:checked').length;
            if (selectedCount === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById('deleteModalText').textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedCount} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π?`;

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const confirmBtn = document.getElementById('confirmDelete');
            confirmBtn.onclick = function() {
                deleteSelectedNotifications();
                modal.hide();
            };

            modal.show();
        });
    }

    if (markSelectedReadBtn) {
        markSelectedReadBtn.addEventListener('click', markSelectedAsRead);
    }

    // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –î–õ–Ø –ß–ï–ö–ë–û–ö–°–û–í
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.notification-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBulkActionButtons();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('notification-checkbox')) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            updateBulkActionButtons();

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"
            const allCheckboxes = document.querySelectorAll('.notification-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');

            if (selectAllCheckbox) {
                selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length;
            }
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ —á–µ–∫–±–æ–∫—Å–∞–º –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('notification-checkbox')) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –≤—Å–µ–º –∫–Ω–æ–ø–∫–∞–º –∏ —Å—Å—ã–ª–∫–∞–º –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ
    document.addEventListener('click', function(e) {
        if (e.target.closest('.notification-actions .btn, .notification-actions a')) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
        }
    });

    // –§–ò–õ–¨–¢–†–´ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    if (filterTabs.length > 0) {
        filterTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
                filterTabs.forEach(t => t.classList.remove('active'));
                // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–µ
                this.classList.add('active');

                const filter = this.dataset.filter;
                console.log('[DEBUG] Filter applied:', filter);

                // –§–∏–ª—å—Ç—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                notificationCards.forEach(card => {
                    let shouldShow = true;

                    switch (filter) {
                        case 'all':
                            shouldShow = true;
                            break;
                        case 'unread':
                            shouldShow = card.dataset.read === 'false';
                            break;
                        case 'system':
                            shouldShow = card.dataset.type === 'system';
                            break;
                        case 'social':
                            shouldShow = card.dataset.type === 'social';
                            break;
                        case 'orders':
                            shouldShow = card.dataset.type === 'order';
                            break;
                        default:
                            shouldShow = true;
                    }

                    card.style.display = shouldShow ? 'block' : 'none';
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
                updateAllCounters();
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateAllCounters();
});
</script>
{% endblock %}
