{% extends "base.html" %}
{% load i18n static %}

{% block title %}{{ page_title }} - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/notifications.css' %}?v=20250601" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="notification-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-0">
                    <i class="fas fa-bell me-3"></i>{{ page_title }}
                </h1>
                <p class="mb-0 mt-2 opacity-75">Управляйте своими уведомлениями</p>
            </div>
            <div class="col-md-4 text-md-end">
                <div class="stats-card d-inline-block">
                    <div class="stats-number" id="total-count-display">{{ total_count }}</div>
                    <div class="small">{% trans "Всего уведомлений" %}</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    {% if notifications %}
        <!-- Фильтры -->
        <div class="filter-tabs">
            <div class="d-flex flex-wrap justify-content-center">
                <button class="filter-tab active" data-filter="all">
                    <i class="fas fa-list me-2"></i>{% trans "Все" %} (<span id="all-count">{{ total_count }}</span>)
                </button>
                <button class="filter-tab" data-filter="unread">
                    <i class="fas fa-envelope me-2"></i>{% trans "Непрочитанные" %} (<span id="unread-count">{{ unread_count|default:0 }}</span>)
                </button>
                <button class="filter-tab" data-filter="system">
                    <i class="fas fa-cog me-2"></i>{% trans "Системные" %}
                </button>
                <button class="filter-tab" data-filter="social">
                    <i class="fas fa-users me-2"></i>{% trans "Социальные" %}
                </button>
                <button class="filter-tab" data-filter="orders">
                    <i class="fas fa-shopping-cart me-2"></i>{% trans "Заказы" %}
                </button>
            </div>
        </div>

        <!-- Массовые действия -->
        <div class="bulk-actions">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAll">
                        <label class="form-check-label fw-bold" for="selectAll">
                            {% trans "Выбрать все" %}
                        </label>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="markSelectedRead" disabled>
                            <i class="fas fa-check me-1"></i>{% trans "Прочитать выбранные" %}
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" id="deleteSelected" disabled>
                            <i class="fas fa-trash me-1"></i>{% trans "Удалить выбранные" %}
                        </button>
                        <button type="button" class="btn btn-primary btn-sm" id="markAllRead">
                            <i class="fas fa-check-double me-1"></i>{% trans "Прочитать все" %}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Список уведомлений -->
        <div class="notifications-list">
            {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% else %}read{% endif %} {% if notification.is_actionable %}clickable{% endif %}"
                     data-type="{{ notification.notification_type }}"
                     data-read="{{ notification.is_read|yesno:'true,false' }}"
                     data-notification-id="{{ notification.id }}"
                     {% if notification.is_actionable and notification.get_action_url %}data-action-url="{{ notification.get_action_url }}"{% endif %}>

                    <!-- Иконка типа уведомления -->
                    {% if notification.notification_type == 'comment' %}
                        <div class="notification-type-icon comment" title="Комментарий">
                            <i class="fas fa-comment"></i>
                        </div>
                    {% elif notification.notification_type == 'like' %}
                        <div class="notification-type-icon like" title="Лайк">
                            <i class="fas fa-heart"></i>
                        </div>
                    {% elif notification.notification_type == 'system' %}
                        <div class="notification-type-icon system" title="Системное">
                            <i class="fas fa-cog"></i>
                        </div>
                    {% elif notification.notification_type == 'order' %}
                        <div class="notification-type-icon order" title="Заказ">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                    {% elif notification.notification_type == 'growlog' %}
                        <div class="notification-type-icon growlog" title="Гроу-лог">
                            <i class="fas fa-seedling"></i>
                        </div>
                    {% elif notification.notification_type == 'social' %}
                        <div class="notification-type-icon social" title="Социальная активность">
                            <i class="fas fa-users"></i>
                        </div>
                    {% else %}
                        <div class="notification-type-icon system" title="Уведомление">
                            <i class="fas fa-bell"></i>
                        </div>
                    {% endif %}

                    <div class="d-flex align-items-start p-3">
                        <!-- Чекбокс для выбора -->
                        <div class="me-3">
                            <input type="checkbox" class="form-check-input notification-checkbox"
                                   data-notification-id="{{ notification.id }}">
                        </div>

                        <div class="notification-content flex-grow-1">
                                <h5 class="notification-title">{{ notification.title }}</h5>
                                <p class="notification-message">{{ notification.message }}</p>

                                <div class="notification-meta">
                                    <span class="notification-date">
                                        <i class="fas fa-clock me-1"></i>
                                        {{ notification.created_at|timesince }} назад
                                    </span>
                                </div>

                                <!-- Кнопки действий -->
                                <div class="notification-actions d-flex align-items-center justify-content-end gap-2">
                                    {% if not notification.is_read %}
                                        <button type="button" class="btn btn-outline-success btn-sm mark-read-btn d-flex align-items-center"
                                                data-notification-id="{{ notification.id }}" title="Отметить как прочитанное">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% endif %}

                                    <button type="button" class="btn btn-outline-danger btn-sm delete-single-btn d-flex align-items-center"
                                            data-notification-id="{{ notification.id }}" title="Удалить уведомление">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
            {% endfor %}
        </div>

        <!-- Пагинация -->
        {% if is_paginated %}
            <nav aria-label="{% trans 'Навигация по страницам' %}">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">{% trans "Первая" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">{% trans "Предыдущая" %}</a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            {% trans "Страница" %} {{ page_obj.number }} {% trans "из" %} {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">{% trans "Следующая" %}</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">{% trans "Последняя" %}</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        {% endif %}

    {% else %}
        <!-- Пустое состояние -->
        <div class="empty-state">
            <div class="empty-state-icon">
                <i class="fas fa-bell-slash"></i>
            </div>
            <h3>{% trans "У вас пока нет уведомлений" %}</h3>
            <p class="text-muted">{% trans "Когда появятся новые уведомления, они будут отображаться здесь" %}</p>
        </div>
    {% endif %}

    <!-- Кнопка возврата -->
    <div class="text-center mt-4 mb-5">
        <a href="{% url 'users:profile' %}" class="btn btn-secondary btn-lg">
            <i class="fas fa-arrow-left me-2"></i>{% trans "Вернуться в личный кабинет" %}
        </a>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Подтверждение удаления" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteModalText">{% trans "Вы уверены, что хотите удалить уведомления?" %}</p>
                <p class="text-muted small">{% trans "Это действие нельзя отменить." %}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Отмена" %}</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">{% trans "Удалить" %}</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast контейнер - используется глобальный из base.html -->

{% endblock %}

{% block extra_js %}
{% csrf_token %}
<script src="{% static 'js/notifications.js' %}?v=20250601"></script>
{% endblock %}
