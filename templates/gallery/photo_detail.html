{% extends "base.html" %}
{% load i18n humanize crispy_forms_tags %}

{% block title %}{{ photo.title|default:_("–§–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏") }} - {% trans "–ì–∞–ª–µ—Ä–µ—è" %}{% endblock %}

{% block extra_css %}
<!-- AOS Animation -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<style>
    /* –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ñ–æ—Ç–æ */
    .photo-detail-page {
        background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
        min-height: 100vh;
        padding: 20px 0;
    }

    .photo-hero {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 0;
        margin-bottom: 2rem;
        border-radius: 1rem;
        position: relative;
        overflow: hidden;
    }

    .photo-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .hero-content {
        position: relative;
        z-index: 2;
    }

    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="photo-detail-page">
    <div class="container">
        <!-- –£–ù–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–ê–Ø MINI-HERO –°–ï–ö–¶–ò–Ø -->
        <div class="photo-hero" data-aos="fade-up" data-aos-duration="600">
            <div class="container">
                <div class="hero-content">
                    <h1 class="mb-0" style="font-size: 1.8rem; font-weight: 700;">
                        üì∏ {{ photo.title|default:_("–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è") }}
                    </h1>
                    <p class="mb-0 mt-2" style="opacity: 0.9;">
                        <a href="{% url 'gallery:gallery' %}" class="text-white-50 text-decoration-none">
                            <i class="fas fa-images me-1"></i>{% trans "–ì–∞–ª–µ—Ä–µ—è" %}
                        </a>
                        <span class="mx-2">‚Ä¢</span>
                        {% trans "–î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä" %}
                    </p>
                </div>
            </div>
        </div>
        <div class="row" data-aos="fade-up" data-aos-delay="100">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞ —Å —Ñ–æ—Ç–æ -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ñ–æ—Ç–æ -->
                <div class="text-center mb-3">
                    {% if photo.image %}
                        <img src="{{ photo.image.url }}"
                             alt="{{ photo.title }}"
                             class="img-fluid rounded"
                             style="max-width: 100%; height: auto; max-height: 70vh; object-fit: contain;">
                    {% else %}
                        <div class="alert alert-warning">{% trans "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç." %}</div>
                    {% endif %}
                </div>

                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
                    <div class="text-muted">
                        <i class="fas fa-user"></i> {% trans "–ê–≤—Ç–æ—Ä" %}:
                        <a href="{% url 'gallery:author_photos' username=photo.author.username %}">{{ photo.author.display_name }}</a>
                        <span class="mx-2">|</span>
                        <i class="fas fa-calendar-alt"></i> {{ photo.created_at|naturalday }}
                    </div>

                    <!-- –£–í–ï–õ–ò–ß–ï–ù–ù–´–ï –ö–ù–û–ü–ö–ò –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• -->
                    <div class="d-flex flex-wrap gap-2">
                        {% if user.is_authenticated %}
                            <button id="like-photo-btn"
                                    data-photo-id="{{ photo.pk }}"
                                    data-url="{% url 'gallery:photo_like' pk=photo.pk %}"
                                    class="btn btn-outline-danger {% if user_liked %}active{% endif %}"
                                    style="min-width: 80px; min-height: 44px;">
                                <i class="fas fa-heart"></i> <span id="likes-count">{{ likes_count }}</span>
                            </button>
                        {% else %}
                            <span class="btn btn-outline-secondary"
                                  style="min-width: 80px; min-height: 44px;"
                                  title="–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ª–∞–π–∫–æ–≤">
                                <i class="fas fa-heart"></i> {{ likes_count }}
                            </span>
                        {% endif %}

                        {% if user.is_authenticated and photo.author == user %}
                            <a href="{% url 'gallery:photo_edit' photo.pk %}"
                               class="btn btn-outline-primary"
                               style="min-height: 44px;">
                                <i class="fas fa-edit"></i>
                                <span class="d-none d-sm-inline">{% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" %}</span>
                            </a>
                            <a href="{% url 'gallery:photo_delete' photo.pk %}"
                               class="btn btn-outline-danger"
                               style="min-height: 44px;">
                                <i class="fas fa-trash"></i>
                                <span class="d-none d-sm-inline">{% trans "–£–¥–∞–ª–∏—Ç—å" %}</span>
                            </a>
                        {% endif %}
                    </div>
                </div>

                {% if photo.description %}
                    <h5><i class="fas fa-info-circle"></i> {% trans "–û–ø–∏—Å–∞–Ω–∏–µ" %}:</h5>
                    <p class="mb-3">{{ photo.description|linebreaksbr }}</p>
                {% endif %}

                {% if photo.growlog %}
                    <div class="alert alert-success">
                        <i class="fas fa-seedling"></i>
                        {% trans "–°–≤—è–∑–∞–Ω–æ —Å –≥—Ä–æ—É-—Ä–µ–ø–æ—Ä—Ç–æ–º" %}:
                        <a href="{% url 'growlogs:detail' pk=photo.growlog.pk %}">{{ photo.growlog.title }}</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="card mt-4" data-aos="fade-up" data-aos-delay="200">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-comments"></i> {% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" %} ({{ comments_count }})</h4>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                    <form method="post" class="mb-4">
                        {% csrf_token %}
                        {{ comment_form|crispy }}
                        <button type="submit"
                                class="btn btn-primary mt-2"
                                style="min-height: 44px;">
                            <i class="fas fa-paper-plane"></i> {% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}
                        </button>
                    </form>
                {% else %}
                    <div class="alert alert-info">
                        <a href="{% url 'account_login' %}?next={{ request.path }}">{% trans "–í–æ–π–¥–∏—Ç–µ" %}</a>,
                        {% trans "—á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π." %}
                    </div>
                {% endif %}

                {% for comment in comments %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-start">
                                <img src="{{ comment.author.profile_extra.avatar.url|default:'/static/images/default_avatar.svg' }}"
                                     alt="{{ comment.author.display_name }}"
                                     class="rounded-circle me-3"
                                     style="width: 45px; height: 45px; object-fit: cover;">
                                <div class="flex-grow-1">
                                    <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-2 gap-2">
                                        <h6 class="mb-0">
                                            <a href="{% url 'gallery:author_photos' username=comment.author.username %}"
                                               class="text-decoration-none">{{ comment.author.display_name }}</a>
                                        </h6>
                                        <small class="text-muted">{{ comment.created_at|naturaltime }}</small>
                                    </div>
                                    <p class="mb-2">{{ comment.text|linebreaksbr }}</p>
                                    {% if user.is_authenticated and comment.author == user %}
                                        <div class="d-flex gap-2">
                                            <a href="{% url 'gallery:edit_comment' comment.pk %}"
                                               class="btn btn-sm btn-outline-secondary"
                                               style="min-height: 36px;">
                                                <i class="fas fa-edit"></i> {% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" %}
                                            </a>
                                            <a href="{% url 'gallery:delete_comment' comment.pk %}"
                                               class="btn btn-sm btn-outline-danger"
                                               style="min-height: 36px;">
                                                <i class="fas fa-trash"></i> {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                                            </a>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-2x mb-3"></i>
                        <p>{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!" %}</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="col-lg-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–≤—Ç–æ—Ä–µ -->
        <div class="card mb-4" data-aos="fade-up" data-aos-delay="150">
            <div class="card-body text-center">
                <img src="{{ photo.author.profile_extra.avatar.url|default:'/static/images/default_avatar.svg' }}"
                     alt="{{ photo.author.display_name }}"
                     class="img-fluid rounded-circle mb-3"
                     style="width: 80px; height: 80px; object-fit: cover;">
                <h5><a href="{% url 'gallery:author_photos' username=photo.author.username %}"
                       class="text-decoration-none">{{ photo.author.display_name }}</a></h5>
                <p class="text-muted small mb-3">
                    {% blocktrans with joined_date=photo.author.date_joined|date:"d.m.Y" %}–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: {{ joined_date }}{% endblocktrans %}<br>
                    {% blocktrans count photos_count=photo.author.photos.count %}–í—Å–µ–≥–æ {{ photos_count }} —Ñ–æ—Ç–æ{% plural %}–í—Å–µ–≥–æ {{ photos_count }} —Ñ–æ—Ç–æ{% endblocktrans %}
                </p>
                <a href="{% url 'gallery:author_photos' username=photo.author.username %}"
                   class="btn btn-outline-primary"
                   style="min-height: 44px;">
                    <i class="fas fa-images"></i> {% trans "–í—Å–µ —Ñ–æ—Ç–æ –∞–≤—Ç–æ—Ä–∞" %}
                </a>
            </div>
        </div>


        </div>
    </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- AOS Animation -->
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<!-- JavaScript –¥–ª—è –ª–∞–π–∫–æ–≤ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AOS
    AOS.init({
        duration: 600,
        easing: 'ease-out',
        once: true,
        offset: 50
    });

    const likeBtn = document.getElementById('like-photo-btn');
    if (likeBtn) {
        likeBtn.addEventListener('click', function(e) {
            e.preventDefault();

            const photoId = this.dataset.photoId;
            const url = this.dataset.url;

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const likesCount = document.getElementById('likes-count');
                    likesCount.textContent = data.likes_count;

                    if (data.liked) {
                        this.classList.add('active');
                    } else {
                        this.classList.remove('active');
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
    }
});
</script>
{% endblock %}
