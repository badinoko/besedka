// ===================================================================
// –ë–ï–ó–û–ü–ê–°–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "JOIN THE CHANNEL" - –ò–ó–ú–ï–ù–ï–ù–ò–ï URL
// ===================================================================
// –°–æ–∑–¥–∞–Ω: 23 –∏—é–Ω—è 2025, 20:25 MSK
// –¶–µ–ª—å: –ë–ï–ó–û–ü–ê–°–ù–û –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å /embed?channel= –≤–º–µ—Å—Ç–æ /channel/?layout=embedded
// –ü–æ–¥—Ö–æ–¥: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã
// ===================================================================

print('üîß –ë–ï–ó–û–ü–ê–°–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ö–ù–û–ü–ö–ò "JOIN THE CHANNEL"...');
print('üéØ –¢–µ—Å—Ç–∏—Ä—É–µ–º /embed?channel= –≤–º–µ—Å—Ç–æ /channel/?layout=embedded');
print('');

// ===================================================================
// 1. –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø
// ===================================================================

print('üìä –ü–†–û–í–ï–†–ö–ê –¢–ï–ö–£–©–ï–ì–û –°–û–°–¢–û–Ø–ù–ò–Ø:');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è owner
const ownerUser = db.users.findOne({ username: 'owner' });
if (!ownerUser) {
    print('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å owner –Ω–µ –Ω–∞–π–¥–µ–Ω!');
    exit(1);
}

print(`   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å owner –Ω–∞–π–¥–µ–Ω: ${ownerUser.username}`);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–∞–ª—ã
const channels = ['general', 'vip', 'moderators'];
let allChannelsExist = true;

channels.forEach(channelId => {
    const channel = db.rocketchat_room.findOne({ _id: channelId });
    if (channel) {
        print(`   ‚úÖ –ö–∞–Ω–∞–ª ${channelId}: "${channel.fname}"`);
    } else {
        print(`   ‚ùå –ö–∞–Ω–∞–ª ${channelId}: –ù–ï –ù–ê–ô–î–ï–ù!`);
        allChannelsExist = false;
    }
});

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏
const ownerSubscriptions = db.rocketchat_subscription.find({ 'u.username': 'owner' }).toArray();
print(`   ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏ owner: ${ownerSubscriptions.length} –∏–∑ ${channels.length}`);

if (!allChannelsExist || ownerSubscriptions.length !== channels.length) {
    print('');
    print('‚ùå –°–ò–°–¢–ï–ú–ê –ù–ï –ì–û–¢–û–í–ê –ö –ò–ó–ú–ï–ù–ï–ù–ò–Ø–ú!');
    print('üîß –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ FINAL_ROCKETCHAT_FIX.js –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
    exit(1);
}

print('');
print('‚úÖ –°–ò–°–¢–ï–ú–ê –°–¢–ê–ë–ò–õ–¨–ù–ê - –ú–û–ñ–ù–û –ü–†–û–î–û–õ–ñ–ê–¢–¨');

// ===================================================================
// 2. –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´
// ===================================================================

print('');
print('üîç –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú–´ "JOIN THE CHANNEL":');
print('');
print('   üìã –¢–ï–ö–£–©–ò–ô URL –§–û–†–ú–ê–¢:');
print('      /channel/{channelId}?layout=embedded');
print('');
print('   ü§î –í–û–ó–ú–û–ñ–ù–ê–Ø –ü–†–ò–ß–ò–ù–ê:');
print('      layout=embedded –ù–ï –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∫—Ä—ã–≤–∞–µ—Ç UI —ç–ª–µ–º–µ–Ω—Ç—ã Rocket.Chat');
print('      –ö–Ω–æ–ø–∫–∞ Join Channel –æ—Å—Ç–∞–µ—Ç—Å—è –≤–∏–¥–∏–º–æ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –∫–∞–Ω–∞–ª–æ–≤');
print('');
print('   üí° –ü–†–ï–î–õ–ê–ì–ê–ï–ú–û–ï –†–ï–®–ï–ù–ò–ï:');
print('      –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å /embed?channel={channelId}');
print('      –≠—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ embed —Ä–µ–∂–∏–º–∞');

// ===================================================================
// 3. –ü–†–û–í–ï–†–ö–ê EMBED ENDPOINT
// ===================================================================

print('');
print('üåê –ü–†–û–í–ï–†–ö–ê EMBED ENDPOINT:');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ iframe
const iframeSettings = [
    'Iframe_Integration_send_enable',
    'Iframe_Integration_receive_enable',
    'Iframe_Restrict_Access'
];

let embedSupported = true;
iframeSettings.forEach(settingId => {
    const setting = db.rocketchat_settings.findOne({ _id: settingId });
    if (setting) {
        print(`   üìã ${settingId}: ${setting.value}`);
        if (setting.value === false && settingId.includes('enable')) {
            embedSupported = false;
        }
    } else {
        print(`   ‚ùì ${settingId}: –ù–ï –ù–ê–ô–î–ï–ù–û (–≤–µ—Ä–æ—è—Ç–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true)`);
    }
});

if (!embedSupported) {
    print('');
    print('‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: Embed –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞');
    print('üîß –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å Iframe_Integration_*_enable –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
}

// ===================================================================
// 4. –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–õ–ê–ù –ò–ó–ú–ï–ù–ï–ù–ò–ô
// ===================================================================

print('');
print('üõ°Ô∏è –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–õ–ê–ù –ò–ó–ú–ï–ù–ï–ù–ò–ô:');
print('');
print('   üìù –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø —à–∞–±–ª–æ–Ω–∞');
print('      –§–∞–π–ª: templates/chat/rocketchat_integrated.html');
print('');
print('   üìù –®–ê–ì 2: –ò–∑–º–µ–Ω–∏—Ç—å URL endpoint');
print('      –û–¢:  /channel/{channelId}?layout=embedded');
print('      –ù–ê:  /embed?channel={channelId}');
print('');
print('   üìù –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
print('      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É –∫–∞–Ω–∞–ª–æ–≤');
print('      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–∞–Ω–∞–ª–∞–º–∏');
print('      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ Join Channel');
print('');
print('   üìù –®–ê–ì 4: –û—Ç–∫–∞—Ç –ø—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö');
print('      - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞');
print('      - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å');

// ===================================================================
// 5. –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ï–ê–õ–ò–ó–ê–¶–ò–ò
// ===================================================================

print('');
print('üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –†–ï–ê–õ–ò–ó–ê–¶–ò–ò:');
print('');
print('   üîß –ò–ó–ú–ï–ù–ï–ù–ò–Ø –í –®–ê–ë–õ–û–ù–ï:');
print('      1. –°—Ç—Ä–æ–∫–∞ 339: src="{{ rocketchat_url }}/embed?channel=general"');
print('      2. –°—Ç—Ä–æ–∫–∞ 376: const newUrl = `{{ rocketchat_url }}/embed?channel=${actualChannelId}`;');
print('      3. –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ console.log —Å–æ–æ–±—â–µ–Ω–∏—è');
print('');
print('   ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ú–û–ú–ï–ù–¢–´:');
print('      - –ù–ï —Ç—Ä–æ–≥–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MongoDB');
print('      - –ù–ï –∏–∑–º–µ–Ω—è—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
print('      - –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã');
print('      - –¢–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ URL –≤ —à–∞–±–ª–æ–Ω–µ');
print('');
print('   üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢:');
print('      - –ö–Ω–æ–ø–∫–∞ Join Channel –∏—Å—á–µ–∑–Ω–µ—Ç');
print('      - –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–æ–≤ —Å—Ç–∞–Ω–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º');
print('      - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—Ç–∞–Ω–µ—Ç —á–∏—â–µ (—Ç–æ–ª—å–∫–æ —á–∞—Ç)');

// ===================================================================
// 6. –ü–õ–ê–ù –û–¢–ö–ê–¢–ê
// ===================================================================

print('');
print('üîÑ –ü–õ–ê–ù –û–¢–ö–ê–¢–ê (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ–π–¥–µ—Ç –Ω–µ —Ç–∞–∫):');
print('');
print('   üìã –ü–†–ò–ó–ù–ê–ö–ò –ü–†–û–ë–õ–ï–ú:');
print('      - Iframe –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è');
print('      - –ö–∞–Ω–∞–ª—ã –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—é—Ç—Å—è');
print('      - –û—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞');
print('      - –ü–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç');
print('');
print('   üö® –î–ï–ô–°–¢–í–ò–Ø –ü–†–ò –ü–†–û–ë–õ–ï–ú–ê–•:');
print('      1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —à–∞–±–ª–æ–Ω –∏–∑ –±—ç–∫–∞–ø–∞');
print('      2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Django —Å–µ—Ä–≤–µ—Ä');
print('      3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å');
print('      4. –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç - –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ');

print('');
print('üéâ –ü–õ–ê–ù –ì–û–¢–û–í –ö –í–´–ü–û–õ–ù–ï–ù–ò–Æ!');
print('üìã –°–ª–µ–¥—É–π—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è');
print('‚ö†Ô∏è –ü–û–ú–ù–ò–¢–ï: –õ—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å –∫–Ω–æ–ø–∫–æ–π, —á–µ–º —Å–ª–æ–º–∞–Ω–Ω–∞—è –±–µ–∑ –Ω–µ—ë!');
